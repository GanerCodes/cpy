ó°‹º(â›ğ, *)
â¨¡ regex as re

show_cache_table = â¥Œğ‘…,â„­â†¦â†¨â„­êŸ¿â¥Œi,vâ†¦â„µ(v)î ó°’¼â†’êŸ¿ó°²£â˜¾â€¹âŸ¦iâŸ§,âŸ¦xâŸ§ğ˜âŸ¦ğ‘…â‚“âŸ§ğ˜âŸ¦yâŸ§â€º

âŠ¢ parse(ğ·, ğ‘…, start_rule=â–¡):
    â„­, Ï‡ = ğ·ğŸƒŒ+1â†’â­¥á´ó°²¡{}, 0
    ğ“¢ = [(â–¡, ğ‘…ğŸƒŒ-1 Â¿start_ruleâ‰…â–¡Â¡ start_rule)]
    Ï‡ = 0
    â°ğ“¢:
        Î§, Î¹ = ğ“¢.pop(Â¯1)
        Â¿Î§â‰‡â–¡: Ï‡=Î§
        Î“ = Ï‡, Î¹
        Î³, â ¤ğ¶ = Ï‰ = ğ‘…ó°ƒ¬
        ğ”  = â„­ó°ƒº
        
        Â¿Î³â‰¡â›á”:
            Â¿ğ¶â‚€â‰¡ğ·ó°ƒºï¹•ôŠ¸´ôŠ®ó°ƒºâ‚ŠôŠ³µôŠ¬£ôŠ¹³: ğ” ó°ƒ¬ = âœ“, ğŒ
            Â¡             : ğ” ó°ƒ¬ = âœ—, Ï‡
        â¸˜Î³â‰¡â›~:
            Â¿mâ‰”ğ¶â‚€.match(ğ·, Ï‡):
                ğ” ó°ƒ¬ = âœ“, Ï‡ + m.group(0)ğŸƒŒ, m
            Â¡:  ğ” ó°ƒ¬ = âœ—, Ï‡
        â¸˜Î³â‰¡â›âˆ§:
            n, ğŒ = ğ” ó°ƒ¬ Â¿Î¹âˆˆğ” Â¡ (0, Ï‡)
            â°âœ“:
                Â¿ğœ¾â‰”ğ¶â‚™ â†’âˆ‰â† ğ‘â‰”â„­ôŠ¸´:
                    ğ“¢.extend([Î“, (ğŒ, ğœ¾)])
                    ğ” ó°ƒ¬ = n, ğŒ ; â‡¥
                ğ‘”, ğŒ = â„­ôŠ¸´ ôŠ¸§ ï¹•â‚‚
                n = n + 1
                Â¿    ğ‘”Â¬: ğ” ó°ƒ¬ = âœ—, Ï‡ ; â‡¥
                Â¿n â‰¡ ğ¶ğŸƒŒ: ğ” ó°ƒ¬ = âœ“, ğŒ ; â‡¥
        â¸˜Î³â‰¡â›âˆ¨:
            n = ğ” ó°ƒ¬ Â¿Î¹âˆˆğ” Â¡ 0
            â°âœ“:
                Â¿ğœ¾â‰”ğ¶â‚™ â†’âˆ‰â† ğ‘â‰”â„­ó°ƒº:
                    ğ“¢.extend([Î“, (Ï‡, ğœ¾)])
                    ğ” ó°ƒ¬ = n ; â‡¥
                ğ‘”, ğŒ = â„­ó°ƒº ôŠ¸§ ï¹•â‚‚
                Â¿    ğ‘” : ğ” ó°ƒ¬ = âœ“, ğŒ, n ; â‡¥
                n += 1
                Â¿n â‰¡ ğ¶ğŸƒŒ: ğ” ó°ƒ¬ = âœ—, Ï‡    ; â‡¥
        â¸˜Î³âˆˆ{â›*, â›+}:
            c = ğ” .setdefault(Î¹, [Ï‡])
            ğœ¾, ğŒ = ğ¶â‚€, câ‚‹â‚
            â°âœ“:
                Â¿ğœ¾ â†’âˆ‰â† ğ‘â‰”â„­ôŠ¸´:
                    ğ“¢.extend([Î“, (ğŒ, ğœ¾)])
                    â‡¥
                ğ‘”, Î§ = â„­ôŠ¸´ ôŠ¸§ ï¹•â‚‚
                Â¿Â¬ğ‘”:
                    Â¿Î³â‰¡â›* âˆ¨ cğŸƒŒ>1:
                        ğ” ó°ƒ¬ = âœ“, ğŒ, cï¹•â‚‹â‚
                    Â¡:
                        ğ” ó°ƒ¬ = âœ—, Ï‡
                    â‡¥
                c.append(ğŒâ‰”Î§)
        â¸˜Î³â‰¡â›âœ“: ğ” ó°ƒ¬ = âœ“, Ï‡
        â¸˜Î³â‰¡â›âœ—: âœ—â¨³â€¹Hit an âœ—â€º
        â¸˜Î³â‰¡â›â†:
            Â¿ğ¶â‚âˆ‰ğ” :
                ğ“¢.extend([Î“, (Ï‡, ğ¶â‚)])
                â†º
            ğ‘”, ğŒ = ğ” ôŠ³µôŠ¬¤ ï¹•â‚‚
            ğ” ó°ƒ¬ = ğ‘”, ğŒ, ğ¶â‚
        Â¡:
            Â¿ğ¶â‚€âˆ‰ğ” :
                ğ“¢.extend([Î“, (Ï‡, ğ¶â‚€)])
                â†º
            ğ‘”, ğŒ = ğ” ôŠ³µôŠ¬£ ï¹•â‚‚
            Â¿Î³â‰¡â›â®: ğ” ó°ƒ¬ = ğ‘” , Ï‡
            â¸˜Î³â‰¡â›Â¬: ğ” ó°ƒ¬ = ğ‘”Â¬, Ï‡
            â¸˜Î³â‰¡â›â—: ğ” ó°ƒ¬ = ğ‘”â¨³, ğŒ
            â¸˜Î³â‰¡â›?: ğ” ó°ƒ¬ = âœ“ , ğŒ, ğ‘”
            Â¡    : ğ” ó°ƒ¬ = ğ‘” , ğŒ
    â†ª â„­

âŠ¢ make_rules(r):
    î¬¦ ó°¤± add option to skip jumping to declarations
    nmp = â„µ(râ»Î¶râ­¥)
    r = r êŸ¿á´· ó°²£â›_+x
    ğ‚ = â„µ(râ»Î¶ğ‘â‰”râ» á´ â›¶áµ€)
    âŠ¢ ğ•Š(r):
        Â¿rğŸƒŒâ‰¡1 âˆ§ râ‚€ â‚€â‰¡â›_: â†ª(râ‚€, )
        Â¿râˆˆğ‚: â†ª ğ‚áµ£
        Â¿râ‚€á¹ğ‘–: r = (ğ‘ôŠµ¬ôŠ®áµ£ôŠ¬£ â‚€, â ¤râ‚ï¹•)
        Â¡    : ğ‘.append(ğ”¦â‰”ğ‘ğŸƒŒ)
        Â¿râ‚€  â‰¡â›â†  : r = (râ‚€, râ‚, ğ•Š(râ‚‚))
        â¸˜râ‚€  âˆˆâ›âœ“â›âœ—: r = (râ‚€, ğ”¦)
        â¸˜râ‚€  âˆ‰â›á”â›~: r = (râ‚€, â ¤râ‚ï¹• á´ ğ•Š)
        î¬¦ ğ‘ôŠ³ôŠ¬ôŠ®ôŠµ¬â‰”r î¬¦ BROKEN ó°¤± FIX â˜¾
        ğ‘ôŠ³ôŠ¬ôŠ®ôŠµ¬=r
        â†ª ğ”¦
    ğ•Š(("T_root", â ¤nmpâºÎ¶râº á´ ğ‘¡))
    ğ‘ = ğ‘ á´ ó°²¡(xâ‚€, â ¤xâ‚ï¹• á´ó°²¡ (râ»ó°‘…á´µ(â‰¡ï(xâ‚€)))Â¿xá¹ğ‘¡Â¡x)
    â†ª â„µô‹†’|nmp
âŠ¢ parse_to_tree(ğ‘…, â„­, â ¤ğ”¸, show_table=âœ—, raise_failed=âœ“):
    Â¿ğ”¸ğŸƒŒâ‰¡2: Ï‡, Î¹ = ğ”¸
    Â¡    :
        Ï‡, Î¹ = 0, ğ”¸â‚€
        Â¿show_table: show_cache_table(ğ‘…, â„­)
    rec = parse_to_treeï(ğ‘…, â„­, raise_failed=raise_failed)
    Î³, â ¤C = ğ‘…ó°ƒ¬
    Â¿Î¹âˆ‰ğ” â‰”â„­ó°ƒº: â†ª Î³, â€¹â€¼âˆ„â€¼â€º
    ğ‘”, ğŒ, â ¤ğ´ = ğ” ó°ƒ¬
    (Â¬raise_failed âˆ¨ ğ‘”)â¨³â€¹Failed to parse tree!â€º
    
    Â¿Î³â‰¡â›âˆ§:
        o = []
        âˆ€râˆˆC:
            o.append(rec(Ï‡, r))
            Â¿râˆ‰ğ” â‰”â„­ó°ƒº: â‡¥
            Ï‡ = ğ” áµ£ â‚
        â†ª Î³, â ¤o
    Â¿Î³â‰¡â›á”: â†ª Î³, Câ‚€
    Â¿Â¬ğ´ âˆ§ Î³âˆˆ{â ¤â€¹âˆ¨*+~â†?â€º}: â†ª Î³, â€¹â€¼âˆ…â€¼â€º
    Â¿Î³â‰¡â›~: â†ª Î³, ğ´â‚€.group(0) î¬¦ â—„ ((â˜¾Â´(ğ´â‚€, â€¹STR="âŸ¦ğ´â‚€.group(0)âŸ§"â€º)).group(0))
    Â¿Î³â‰¡â›âˆ¨: â†ª Î³, rec(Ï‡, CôŠ³³ôŠ¬£)
    Â¿Î³â‰¡â›â†: â†ª Î³, Câ‚€, rec(Ï‡, ğ´â‚€)
    Â¿Î³â‰¡â›?: â†ª Î³, â ¤ğ´â‚€ âˆ§ rec(Ï‡, Câ‚€)â›¶áµ€ âˆ¨ ()
    Â¿Î³âˆˆ{â ¤â›*â›+}: â†ª Î³, â ¤ğ´â‚€ á´ recï(â¬¤, Câ‚€)
    Â¿Î³âˆˆ{â ¤â›âœ“â›âœ—}: â†ª Î³, 
    â†ª Î³.removeprefix(â›_), rec(Ï‡, Câ‚€)

âŠ¢ chop_tree(ó±•, ğ·, remove_trashes=âœ“,
             remove_failed_questions=âœ“,
             remove_lookaheads=âœ“):
    
    pops = â€¹âˆ§âˆ¨âœ“âœ—*+â—â ¶â€º + â›?â‹…remove_failed_questions â›
                      + â›â®â›Â¬â‹…remove_lookaheads
    
    âŠ¢ reform_str(ó±•):
        ó±•áµ—, ó±•á¶œ, ó±•áµ‰ áµ€ = ó±•á¶œâ‚€áµ—, [], âœ“
        â†ª ó±•
    ó±•.ftrp(â›á”â›~, reform_str)
    
    Â¿remove_trashes: ó±• = Åƒ.filter(ó±•, ó°²¡xáµ‰ áµ€âˆ¨xáµ—â‰ â›ó°†´)
    
    âŠ¢ splat(ó±•):
        Æ’ = ó°²¡(xá´ó°²¡xá¶œó°…‚Î£[]) Â¿xáµ—â‰¡â›â ¶Â¡ xá¶œ
        ó±•á¶œ = ó±• á´ó°²¡Æ’(x) Â¿xá¹Åƒâˆ§Â¬xáµ‰ áµ€âˆ§xáµ—âˆˆpopsÂ¡ xâ›¶ó°…‚ Î£[]
        â†ª ó±•
    ó±•.frp(ó°²¡Â¬xáµ‰ áµ€, splat, pre=âœ“)
    
    âŠ¢ get_txt(ó±•):
        l = []
        ó±•.frp(ó°²¡xáµ‰ áµ€, ó°²¡l.append(xáµ—)â–ºx, pre=âœ“)
        â†ª lÎ£á¦
    ó±•.ftrp(â›Æ¨, ó°²¡Åƒ(get_txt(x), e=â„µ(T=âœ“)))
    
    âŠ¢ set_arrows(ó±•):
        Â¿ó±•áµ‰ áµ€: â†ª
        âˆ€i,c âˆˆ ó±•â†¨:
            Â¿cáµ—â‰¡â›â†:
                ó±•áµ‰î ôŠ¬£ôŠ«¼ = ó±•áµ¢ = câ‚
            set_arrows(c)
    set_arrows(ó±•)
    
    â†ª ó±•

parse_to_node = ó±•â†¦(Æ’ â‰” ó°²¡Åƒ(x, â ¤ğ”¸á´ó°²¡Æ’(â ¤xÂ¿xá¹ğ‘¡Â¡xâ›¶áµ€)))(â ¤ó±•)

Î© Peggle2:
    __slots__ = â€¹rulesâ€‰Râ€ºâ­
    âŠ¢ __init__(ğ•Š, g): ğ•ŠÊ³áµ˜Ë¡áµ‰Ë¢, ğ•Šá´¿ = (gÊ³áµ˜Ë¡áµ‰Ë¢, gá´¿) Â¿gá¹Peggle2Â¡ (g, make_rules(g))
    âŠ¢ __repr__(ğ•Š): â†ª â€¹âŸ¦á¹ğ•Šâ†’.__name__âŸ§[âŸ¦ğ•ŠÊ³áµ˜Ë¡áµ‰Ë¢ğŸƒŒâŸ§ Rules, âŸ¦ğ•Šá´¿ áµ€ô‹•ŸÊ³áµ’áµ’áµ—ğŸƒŒâŸ§ Normalized]â€º
    âŠ¢ __contains__(ğ•Š, x): â†ª xâˆˆğ•ŠÊ³áµ˜Ë¡áµ‰Ë¢
    âŠ¢ __or__(ğ•Š, h, allow_conflict=âœ—):
        Â¿há¹ğ•Š: h = hÊ³áµ˜Ë¡áµ‰Ë¢
        conflict = (ğ•ŠÊ³áµ˜Ë¡áµ‰Ë¢.keysî®¦)âˆ©(h.keysî®¦)
        Â¬(allow_conflict âˆ§ conflict)â¨³â€¹Conflicting rules! âŸ¦conflictâŸ§â€º
        â†ª (á¹ğ•Š)(Peggle2(ğ•ŠÊ³áµ˜Ë¡áµ‰Ë¢ | h))
    âŠ¢ __call__(ğ•Š, content, rule="main", DEBUG=âœ—, chop=âœ“, â ¶ğ•‚):
        DEBUGÂ¬â¨³"Not implemented."
        c, r = content, rule
        root, rule = ğ•Šá´¿ áµ€ô‹•ŸÊ³áµ’áµ’áµ—, ğ•Šá´¿áµ£
        â„­ = parse(c, root, rule)
        ó±• = parse_to_node(parse_to_tree(root, â„­, rule))
        ğ’¸ = ğš²chop_tree(ó±•, c, â ¶ğ•‚)
        â†ª ğ’¸î®¦ Â¿chopÂ¡ â„µ(table=â„­, tree=ó±•, chop=ğ’¸)
    âŠ¢ print_rules(ğ•Š):
        ğ•ŠÊ³áµ˜Ë¡áµ‰Ë¢.itemsî®¦êŸ¿ó°²£(â€¹âŸ¦xâŸ§:â€ºâ˜¾, yâ˜¾)
    âŠ¢ print_normalized(ğ•Š):
        ğ•Šá´¿ áµ€ô‹•ŸÊ³áµ’áµ’áµ—â†¨ êŸ¿ó°²£ â˜¾â€¹âŸ¦xâŸ§ğ˜âŸ¦ğ˜€.join(yá´á”)âŸ§â€º

__exports__ = Peggle2, 

â®Œ node â¨¡ Node

âŠ¢ peggle122(rules):
    âŠ¢ Æ’(x):
        Â¿xáµ—â‰¡â›â†: â†ª (xáµ—, xâ‚€á¶œ, Æ’(xâ‚))
        Â¿xáµ—â‰¡"rname": â†ª (â›_â‹…(xá¶œâˆ‰â›âœ“â›âœ—)+xá¶œ, )
        â†ª xáµ—, â ¤((xá¶œ á´ Æ’) Â¿xá´¸Â¡ (xá¶œ, ))
    â†ª â„µ(rules) êŸ¿â±½ ó°²£Æ’(y)
âŠ¢ peggle221(ó±•):
    âŠ¢ Æ’(ó±•):
        s = â„µ()
        âˆ€k,v âˆˆ ó±•áµ‰:
            Â¿kâ‰¡â›T: â†ªNode(c=ó±•áµ—)
            sô‹‘ºôŠ¬„ô‹•œáµ¢â‚™î â‚‘â‚“â‚áµ¥â‚ = k
        c = ó±•á´Æ’
        âˆ€i,vâˆˆs: cáµ¢áµ‰ = v
        â†ªNode(ó±•áµ—, c)
    ó±• = Æ’(ó±•)
    â†ª ó±•.find_replace(ó°²¡xğŸƒŒâ‰¡1 âˆ§ xá¶œâ‚€á¹Node âˆ§ Â¬xá¶œâ‚€áµ—, ó°²¡x.copy(c=xáµ—Ë£áµ—))

Î© ForcefeedPeggle1Peggle2(Peggle2):
    âŠ¢ __init__(ğ•Š, x):
        Â¿xá¹Peggle2: super().__init__(x)
        Â¡         : super().__init__(peggle122(x))
    âŠ¢ __call__(ğ•Š, â ¤ğ”¸, â ¶ğ•‚):
        â†ª peggle221(super().__call__(â ¤ğ”¸, â ¶ğ•‚))
    âŠ¢ __or__(ğ•Š, x):
        â†ª super().__or__(peggle122(x))

GRANDMA_RULES = Å•â‰”(â ¤map(re.compile, (('[\ueb26#][^\\n]*'), ('[â¯…â¯†â–³â–½â†·]'), ('"(â›.|[^"])*"'), ("'(â›.|[^'])*'"), ('â€¹(â›.|[^â€º])*â€º'), ('[^â¯…â¯†â–³â–½â†·ó°†´()?â—â®.:â ¶Æ¨âœ—+*=Â¬âˆ¨âˆ§~â€¹#î¬¦\'" \\t\\n]+|âœ—'), ('[ó°†´â—â®â ¶Æ¨~Â¬]'), ('[*+?]'), ('([ \\t]|â›\\n)+'), ('([ \\t\\n]|â›\\n)+'))),) â†’â–ºâ† â„µâˆ˜{'statements':('âˆ¨',('âˆ§',('?',('_W',)),('*',('âˆ§',('âˆ¨',('_comment',),('_elm_o',)),('?',('_W',)))))),'comment':('âˆ¨',('~',Å•[0])),'elm_o':('âˆ¨',('âˆ§',('_elm_a',),('*',('âˆ§',('?',('_W',)),('á”','âˆ¨'),('?',('_W',)),('_elm_a',))))),'elm_a':('âˆ¨',('âˆ§',('_elm_j',),('*',('âˆ§',('âˆ¨',('âˆ§',('?',('_W',)),('á”','âˆ§'),('?',('_W',))),('?',('_w',))),('_elm_j',))))),'elm_j':('âˆ¨',('__elm_j',),('_elm',)),'_elm_j':('âˆ¨',('âˆ§',('_elm',),('?',('_W',)),('~',Å•[1]),('?',('_W',)),('âˆ¨',('__elm_j',),('_elm',)))),'elm':('âˆ¨',('âˆ§',('_prefix',),('âˆ¨',('_assign_eql',),('_assign_cln',),('_group',),('_str',),('_rname',)),('_suffix',))),'assign_eql':('âˆ¨',('âˆ§',('_rname',),('?',('_W',)),('á”','='),('?',('_W',)),('_elm_o',))),'assign_cln':('âˆ¨',('âˆ§',('_rname',),('?',('_W',)),('á”',':'),('?',('_W',)),('_elm_j',))),'group':('âˆ¨',('âˆ§',('á”','('),('?',('_W',)),('_group_inner',),('á”',')'))),'group_inner':('âˆ¨',('*',('âˆ§',('_elm_o',),('?',('_W',))))),'str1':('âˆ¨',('~',Å•[2])),'str2':('âˆ¨',('~',Å•[3])),'str3':('âˆ¨',('~',Å•[4])),'str':('âˆ¨',('_str1',),('_str2',),('_str3',)),'rname':('âˆ¨',('~',Å•[5])),'prefix':('âˆ¨',('âˆ§',('?',('_w',)),('+',('âˆ§',('~',Å•[6]),('?',('_W',))))),('?',('_w',))),'suffix':('âˆ¨',('âˆ§',('+',('âˆ§',('?',('_W',)),('~',Å•[7]))),('?',('_w',))),('?',('_w',))),'w':('âˆ¨',('~',Å•[8])),'W':('âˆ¨',('~',Å•[9]))}
BOOTSTRAP = Peggle2(GRANDMA_RULES)
BOOTSTRAP_PEGGLE1 = ForcefeedPeggle1Peggle2(BOOTSTRAP)

Â¿ __name__â‰¡"__main__":
    RULE = "statements"
    CONTENT = ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
    main    = ó°†´W? (entry ó°†´W?)*
    entry   = (
        Æ¨(section=ó°†´'[' wrd ó°†´']') ó°†´W?
        (pair = (
            (bruh:key = â ¶wrd) ó°†´(w? â†· '=')
            (value = (wrd âˆ¨ str)+) ó°†´W? ) )* )
    str     = ~â€¹"[^"]+"â€º
    wrd     = ~â€¹[-\w]+â€º
    w       = ~â€¹[ \t]+â€º
    W       = ~â€¹[ \t\n]+â€º
    ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥

    BOOTSTRAPâ˜¾
    ó±• = BOOTSTRAP(CONTENT, RULE)
    "FINISHED"â˜¾
    ó±•á´¾î®¦â˜¾