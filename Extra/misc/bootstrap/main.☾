â®Œ whitespace_tools â¨¡ whitespace_parser, whitespace_unparser, add_spaces
â®Œ py_naming_tools â¨¡ py_special_mapper, py_escape_string, py_escape_var
â®Œ string â¨¡ ascii_uppercase, ascii_lowercase, digits
â®Œ util â¨¡ SCRIPT
â¨¡ regex as re
â®Œ op â¨¡ OP
ó°‹º(â›ğ, *) ; ó°‹º("peggle2", *)

âŠ¢ make_op_call(op, l, r, op_):
    ch = nâ†¦ná¹ğ‘™ â­œ(nâ‰…â–¡ â­œNULLâ­ into_expr(n))â­ n
    â†ª Åƒ("op_call", [ch(l), op_, ch(r)])

âŠ¢ create_precedences(tiers, specials, Æ’=ó°»¾):
    ğ = {}
    âˆ€tier âˆˆ tiersá´™:
        ğ¶ = ğ‘ â†ğ.keysî®¦
        T = ğ‘ â†tieráµâ‚€
        âˆ€ğ“½,ğ“¶ âˆˆ tier:
            ğ¶ = ğ¶.copyî®¦
            Â¿â›Iâˆˆğ“¶: ğ¶ âˆª= T
            
            ğ¾ = {}
            Â¿ğ“¶âˆ©"BS": ğ¾ôŠ¯›ó°‚ = ğ¶.copy()
            Â¿ğ“¶âˆ©"BP": ğ¾ôŠ¯›ó°‚¤ = ğ¶.copy()
            ğô‹š¾ = OP(ğ“½, ğ“¶, â ¶ğ¾)â‰•ğ¨ â—„ (ğ¨á¶ â‰”make_op_callï(ğ¨))
    
    ğ = {}
    âˆ€L,(ğ“½,ğ“¶),R âˆˆ specials:
        L_c = L â­œğó°‚á´¸âˆªğó°‚á´¿â­ {}
        R_c = R â­œğó°‚¤á´¸âˆªğó°‚¤á´¿â­ {}
        âˆ€câˆˆğ:
            Â¿câˆ‰L_c âˆ§ (Oâ‰”ğî )á´¾á´®: Oá´¿ âˆª= {ğ“½}
            Â¿câˆ‰R_c âˆ§ (Oâ‰”ğî )á´¾á´®: Oá´¸ âˆª= {ğ“½}
        
        ğ¾ = {}
        Â¿L: ğ¾ôŠ¯›ó°‚ = ğ.keysî®¦âˆ–ğó°‚á´¸ âˆª {L}
        Â¿R: ğ¾ôŠ¯›ó°‚¤ = ğó°‚¤á´¿
        ğô‹š¾ = (OP(ğ“½, ğ“¶, â ¶ğ¾)â‰•ğ¨)â—„(ğ¨á¶ â‰”make_op_callï(ğ¨))
    ğ |= ğ
    
    â†ª Æ’âˆ˜ğ

âŠ¢ Æ’(ğ):
    IG = {â›.}
    sel = [â ¤ğ.valuesî®¦áµá´®âˆ§â›Î´âˆ‰âŸâ­œ(âŸáµ—+â›=,âŸ)â­ó°®ˆá¸, (":=", ğôŠ¯›ôŠ®), (â›â‰”, ğ.pop(â›â‰”))]
    new_ops = {}
    asn_l, asn_r = ğ["â€ASGN_MRK_R"]á´¸, ğ["â€ASGN_MRK_R"]á´¿
    âˆ€k,vâˆˆsel:
        new_opsâ‚– = OP(k, "B=", IG, asn_r, vá¶ )
    ğ |= new_ops
    âˆ€k,vâˆˆğ.items():
        Â¿kâˆˆIG: â†º
        vá´¿ âˆª= ğ‘ (new_ops)
    
    ğôŠ¯›ôªª = OP(k, "B=", asn_l, IG, vá¶ )
    ğôŠ¯›ôŠ±¼á´¿ âˆª= ğ‘ ("â†’â­¢")
    ğôŠ¯›ôŠ­¨á´¿ âˆª= ğ‘ ("â­¢")
    â†ª ğ

âŠ¢ convert_opblock(ğ•):
    Î±,Î² = ğ•.stripî®¦ ó·¹ ğ—»ğ—»
    ğ’» = á‘€â‚€â‹„SCRIPT.nrm(âŸâ‚)
    ğ“ˆ = ğ’»â—‹ó·º¹ğŒ‚Â¹ó·º¹âˆˆSCRIPT.CHAR_SUPá¸â†’ó°¸·ôŠ¾–2
    ops = Î±â¥‰(â›â›ğ—»â‹„â›â‰â†’ó°›”â†ğ˜€â‹„ğ—»)â†’ó·¹ğ—»áµó·¹ğ˜€á´ğ“ˆ
    ops_spec = Î²ó·¹ğ—» á´ğ˜€ó°›”á¦ áµó·¹(á‘€â‰¡â›ï½œâ­œó°®ˆ)á´â¨â†’êŸ¿â°ó°²¥xâ‹„(ğ“ˆâˆ˜y)â‹„z
    â†ª create_precedences(ops, ops_spec, Æ’)

ó±€˜ Transpiler:
    âŠ¢ __init__(ğ•Š, gram, charsets):
        Â¿gram á¹ á”: gram = peggle2(gram)
        
        gram |= charsetsêŸ¿á´°ó°²£( î¬¦ this is stupid
            x á£†Ë£ô©…ô‹…±ô‹¤ô‹•©ô‹•Ÿá´¾ô‹•© ó·º¹ï¹•ô§°, (
                â›~, ğ•Š.to_or_rgx(y) á£†Ë£ô©…ô‹…±ô‹¤ô‹•©ô‹•Ÿá´¾ô‹•© ó°²¡â€¹(âŸ¦xâŸ§)+â€ºó°…‚ â¥‰ re.compile))
        î¬¦ gram.print_rulesî®¦
        ğ•Š.gram = gram
    
    âŠ¢ to_or_rgx(ğ•Š, s): î¬¦ ó°¤± fix
        rgx_ranges = á‘€ó°’¼Î±â‰”ordâ—‹ó·¸ºâ†’á™¡ô‹‚êœáµá´Î±â‰•hâ†’â¨â‰¡3hâ‚€+3â­œâ›-â­âŸâ‚á¸Å¿ó·º¹+âŸâ‹…â†âŸô¨„â‰ âŸô¨„á˜
        ğ•¤,ğ• = sáš¤â†’ó°’¼ğŸƒŒâ†’î®†á´®âŸ¥á‘€ğŸƒŒ>1
        ğ•¤ = â›[+rgx_ranges(ğ•¤ó°’¼á–â€¹\^]-â€ºó°Œ· â†’ó°›”ôªµâ† â€¹\\â€‰\^â€‰\]â€‰\-â€ºâ­)+â›]
        ğ• = ğ• á´ re.escape
        â†ª ğ•¤+ğ•âŸ•â°â›|
    
    âŠ¢ __call__(ğ•Š, c, rule="main"):
        â†ª ğ•Š.gram(c, rule)

ó°‹º("data.â˜¾", *)

ops = convert_opblock(OPERATORS)
î¬¦ âˆ€k,vâˆˆops.itemsî®¦: â€¹âŸ¦vâŸ§ğ—»âŸ¦vá´¸â¨â›â”‚âŸ§ğ—»ğ—»âŸ¦vá´¿â¨â›â”‚âŸ§ğ—»ğ—»â€ºâ˜¾

add_swaps = á‘€âˆª â† SWAP_TABLE ó°ˆ² ï€…ó°²£yâˆˆâŸó°…‚ áµâ‚€
rmk = ó°²£{k:v âˆ€k,vâˆˆx.items() Â¿kâˆ‰y}
SWAP_TABLE = â„µ(SWAP_TABLE)
kw_pfx_colon   = add_swaps(kw_pfx_colon)
kw_neverswouce = add_swaps(kw_neverswouce)
kw_inline      = add_swaps(kw_inline) âˆª kw_neverswouce
kw_pfx         = add_swaps(kw_pfx)
KEYWORDS_TO_CPY=rmk(SWAP_TABLE á´á´° á´™, â€¹*â€‰**â€ºâ­)
kw=kw_pfx_colon|kw_pfx|kw_inline
lets=ascii_uppercase+ascii_lowercase+digits
kw_spec = ğ‘ (kw ó°ˆ³ ó·º¹âˆ©lets)

ğš = Transpiler(GRAM, â„µ(
    kw_pfx_colon=kw_pfx_colon,
        var_spec=var_spec,
         kw_spec=kw_spec,
          kw_pfx=kw_pfx,
              kw=kw,
        oper_lit=ops.keysî®¦,
     SUPSCRIPT_P=ğ‘ (SCRIPT.CHAR_SUP),
     SUBSCRIPT_P=ğ‘ (SCRIPT.CHAR_SUB)))
ğš("2", "parser_main")á´¾î®¦
î¬¦ ğš.gram.print_rulesî®¦

exitî®¦

py_escape_var = py_escape_varï(â¬¤,âœ“)

ğšƒ      = ó°²¡Åƒ(x,e=â„µ(T=âœ“))
mkexp  = ğš²Åƒ("expr", â ¤ğ”¸)
mkstr  = ó°²¡Åƒ("str", ğšƒ(â›"), ğšƒ(x), ğšƒ(â›"))
mkvar  = ó°²¡Åƒ("var", ğšƒ(x))
mkgrp  = â¥Œâ ¤ğ”¸,b="()"â†¦Åƒ("group", ğšƒ(bâ‚€), ğ”¸ğŸƒŒâ‰¡1â­œğ”¸â‚€â­ğ”¸, ğšƒ(bâ‚))
mkexp_ = ğš²Node("expr_", ğ”¸â¥‰ğ‘™)
fcall_ = â¥Œf,â ¤ğ”¸,E=â–¡â†¦mkexp_(f, mkgxp_(ğ”¸ â¨ COMMA), â ¤Eâˆ¨[])
mkgxp  = mkgrp â—‹ mkexp
mkgxp_ = mkgrp â—‹ mkexp_
mknex_ = ó°²£mkexp_(x, EQCLN, y)

NUM_M2, NUM_M1, NUM_P0, NUM_P1 = ó·°¿ó·¸»1 á–Åƒ("number", ğšƒ(âŸâ¥‰á”))
COMMA, COLON, EQCLN =      â€¹,â€‰:â€‰:=â€ºâ­ á–Åƒ("oper_lit", ğšƒ(âŸ))
ARG_A = mkexp(("oper_lit", â›â ¤), mkvar(â›ğ”¸))
ARG_K = mkexp(("oper_lit", â›â ¶), mkvar(â›ğ•‚))
TAC_L, TAC_R, TRUE, FALSE, Ã¾PSH, Ã¾POP, Ã¾Ã¾ = "âŸâ€‰âŸâ€‰Trueâ€‰Falseâ€‰Ã¾PSHâ€‰Ã¾POPâ€‰Ã¾Ã¾"â­á´mkvar
Ã¾POP_M2, Ã¾POP_M1 = NUM_M2â‹„NUM_M1 á–fcall_(Ã¾POP, âŸ)
Ã¾POPNR = "Ã¾POPNR" â¥‰ mkvar â¥‰ fcall_

kw                = kw_pfx_colon âˆª kw_pfx âˆª kw_inline
kw_spec           = kw ó°ˆ³ ó°²¡x.isalpha() âˆ¨ x.isdigit()ó°…‚ â¥‰ ğ‘ 
OPS_BUILTINôŠ¯›ó°‚“ = OPS_BUILTIN.values() Å¿ âˆª
OPS_COMP = lang.op_orders êŸ¿â±½ ó°²£yó°ˆ²âŸ¥á’â›Î»âˆˆlang.opsâ‚›ó°…‚ ó°ˆ²

î¬¦ forced to be one char, will not act as object or attr-getter when superscript
escaped_var_specs = var_spec á´ py_escape_var â¥‰ ğ‘ 