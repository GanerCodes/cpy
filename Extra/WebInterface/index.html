<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="icon" type="image/svg+xml" href="moon.svg"/>
        <title>WASMoon</title>
        <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
        <style>
            @font-face {
                font-family: 'JuliaMonoCustom';
                src: url('font.ttf') format('truetype'); }
            :root {
                --rainbowDark: linear-gradient(45deg, rgba(255,0,0,0.75) 0%, rgba(255,154,0,0.75) 10%, rgba(208,222,33,0.75) 20%, rgba(79,220,74,0.75) 30%, rgba(63,218,216,0.75) 40%, rgba(47,201,226,0.75) 50%, rgba(28,127,238,0.75) 60%, rgba(95,21,242,0.75) 70%, rgba(186,12,248,0.75) 80%, rgba(251,7,217,0.75) 90%, rgba(255,0,0,0.75) 100%); }
            * {
                box-sizing: border-box;
                overflow-wrap: anywhere;
                text-wrap: wrap;
                font-size: 25px;
                line-height: 1.1333333em;
                font-family: 'JuliaMonoCustom' !important; }
            
            ::-webkit-scrollbar-thumb {
                background-image: var(--rainbowDark);
                box-shadow: inset 2px 2px 5px 0 rgba(#fff, 0.5);
                border-radius: 100px; }
            ::-webkit-scrollbar { width: 0.4vw; }
            
            html, body {
                background: #000; color: #fff;
                width: 100%; height: 100%;
                margin: 0%; padding: 0%; }
            
            .rowOfFlex {
                display: flex;
                justify-content: center;
                margin-left: auto;
                margin-right: auto;
                height: 100%; }
            .rowOfFlex > * {
                display: inline-flex;
                justify-content: start;
                align-content: start;
                align-items: center;
                overflow-y: scroll;
                flex-basis: 0;
                height: 100%; }
            #entries {
                flex-grow: 3;
                flex-flow: column;
                border: 1px solid #fff;
                border-radius: 2px; }
            #symbolTable {
                flex-grow: 1;
                display: grid;
                grid-template-columns: repeat(auto-fill, 27px);
                justify-items: center;
                justify-content: center;
                user-select: none; }
            .entry, textarea {
                border: none;
                width: 100%;
                margin: 0px;
                padding: 0px; padding-left: 2px; padding-right: 2px;
                white-space: pre; }
            textarea {
                resize: none;
                overflow: hidden;
                background: #112;
                color: #fff;
                caret-color: #939;
                outline: none;
                height: 1.1em;
                min-height: 1.1em; }
            #symbolTable > text:hover  * { background: #102; }
            #symbolTable > text:active * { background: #214; }
            #symbolTable > text:hover {
                font-size: 110%;
                cursor: pointer; }
            #symbolTable > text:active {
                font-size: 120%; }
            #symbolTable text {
                display: block;
                width: 100%;
                aspect-ratio: 1;
                align-content: center; }
            #symbolTable text:not(:has(> *)) {
                border: 0.5px solid #222;
                text-align: center; }
        </style>
    </head>
    <body>
        <div class="rowOfFlex">
            <div id="entries">
                <textarea id="cli_in" class="entry" style="height:1em"
                          spellcheck="false" oninput="auto_grow(this)"></textarea>
            </div>
            <div id="symbolTable"></div>
        </div>
        
        <script type="text/javascript">
            var py, hist=[""], hist_p=0;
            const script = (x, m) => py.globals.get("SCRIPT")[m](x);
            
            const safeRunMoon = val => py.runPython(`
                try:
                    ùëì("${val.replaceAll(/[\\"\n]/g, x=>({"\\":"\\\\","\n":"\\n",'"':'\\"'}[x]))}")
                except Exception as e:
                    print("Error:", e)`);
            
            // mfw "‚Ñö".length !== "ùïä".length
            const ·îês = (x,...ùî∏) => [...x].slice(...ùî∏).join('');
            const ·îêùëô = x => [...x].length;
            const QS  = (x, Œµ=document) => Œµ.querySelector(x);
            const QSA = (x, Œµ=document) => Œµ.querySelectorAll(x);
        
            const ets = document.getElementById("entries");
            const cli = document.getElementById("cli_in");
            const syt = document.getElementById("symbolTable");
            
            const p2rc = (s,   ùëù  ) => {
                let r=0, c=0, i=0, S=[...s];
                for(g=0; i < S.length; g+=S[i++].length) {
                    if  (  g  ==   ùëù ) break;
                    if  (S[i] == '\n') r++, c=0;
                    else                    c++; }
                return [r,c]; };
            const rc2p = (s, [ùëü,ùëê]) => {
                let r=0, c=0, i=0, S=[...s];
                for(   ; i < S.length;      i++) {
                    if  (c==ùëê && r==ùëü) break;
                    if  (S[i] == '\n') r++, c=0;
                    else                    c++; }
                return S.slice(0,i).join('').length; };
            const sel_p  = Œµ => [Œµ.selectionStart, Œµ.selectionEnd];
            const sel_rc = Œµ => sel_p(Œµ).map(x => p2rc(Œµ.value, x));
            const caret_write = (Œµ, t) => {
                Œµ.focus();
                const [l, r] = sel_p(Œµ);
                Œµ.setRangeText(t, l, r, 'select');
                if(l == r) Œµ.setSelectionRange(l+t.length, l+t.length); }
            const replace_selection = (Œµ, ùëì) => {
                const [l, r] = sel_p(Œµ);
                const v = Œµ.value
                const x = v.slice(l, r);
                const X = ùëì(x);
                Œµ.value = v.slice(0, l) + X + v.slice(r);
                Œµ.setSelectionRange(l, l+X.length); };
            const indent = (Œµ, num=1, nspace=4) => {
                const L = Œµ.value.split('\n');
                let [[RŒ±, CŒ±], [Rœâ, Cœâ]] = sel_rc(cli);
                let rows = L.slice(RŒ±, Rœâ+1);
                let Œîc = {};
                
                const wrap = ùëì => (x, i) => (Œîc[RŒ±+i] = ·îêùëô(r=ùëì(x))-·îêùëô(x), r);
                if(num > 0) {
                    const pad = ' '.repeat(nspace*num);
                    rows = rows.map(wrap(x => pad + x));
                }else if(num < 0) {
                    const ùîØ = new RegExp(String.raw`^ {0,${-num*nspace}}`, "g");
                    rows = rows.map(wrap(x => x.replace(ùîØ, ''))); }
                
                L.splice(RŒ±, Rœâ-RŒ±+1, ...rows);
                Œµ.value = L.join('\n');
                CŒ± += Œîc[RŒ±];
                Cœâ += Œîc[Rœâ];
                const [pŒ±, pœâ] = [[RŒ±, CŒ±], [Rœâ, Cœâ]].map(x => rc2p(Œµ.value, x));
                Œµ.setSelectionRange(pŒ±, pœâ); };
            const enter_preserve_indent = (Œµ) => {
                const L = Œµ.value.split('\n');
                let [[RŒ±, CŒ±], [_, __]] = sel_rc(cli);
                const [Œ±,Œ≤] = [·îês(L[RŒ±], 0, CŒ±), ·îês(L[RŒ±], CŒ±)];
                const ind = Œ±.match(/^ */)[0];
                L.splice(RŒ±, 1, Œ±, ind+Œ≤);
                Œµ.value = L.join('\n');
                const p = rc2p(Œµ.value, [RŒ±+1, ind.length]);
                Œµ.setSelectionRange(p, p); };
            
            const reformt = s => {
                const ùëì = (x, ...ùî∏) => {
                    const Œµ = document.createElement("text");
                    const hasStyle = x.length && x[0] == "\x1c";
                    hasStyle ? Œµ.style=x.slice(1) : Œµ.innerText=x;
                    if(ùî∏.length) {
                        const Œ≥ = ùëì(...ùî∏);
                        if(!hasStyle && !x) return Œ≥;
                        if(Œ≥.innerText) Œµ.appendChild(Œ≥); }
                    return Œµ; };
                return ùëì(...("[0m"+s).replace(/\x1b\[(38|48);2;([0-9]{0,3});([0-9]{0,3});([0-9]{0,3})m/gm,
                                               (_,t,r,g,b)=>"\x1b\x1c"+`${t=="38"?"color":"background-color"}:#${
                                                    (256*(256*Number(r)+Number(g))+Number(b)).toString(16).padStart(6, '0')}\x1b`)
                                      .replace(/\033\[0m/gm,
                                               "\x1b\x1c"+"color:#fff;background-color:#000\x1b")
                                      .split("\x1b")); };
            
            const log = x => {
                console.log(`Logging: "${x}"`);
                const Œµ = document.createElement("div");
                Œµ.className = "entry";
                Œµ.appendChild(reformt(x));
                ets.insertBefore(Œµ, cli);
                setTimeout(_ => { cli.scrollIntoView(); cli.focus(); }, 25);
                return x; }
            
            const log_as_user = x => {
                log(x);
                hist[  hist_p] = x;
                hist[++hist_p] = "";
            };
            
            const auto_grow = Œµ => (Œµ.style.minHeight = "1em",
                                    Œµ.style.minHeight = `${Math.max(5, Œµ.scrollHeight)}px`,
                                    Œµ.scrollIntoViewIfNeeded());
            
            const load_python = async _ => {
                log("Loading WASM Python‚Ä¶");
                py = await loadPyodide({ stdin: prompt, stdout: log, stderr: log });
                log("Loaded WASM Python");
                await py.runPythonAsync(`
                    import shutil
                    from pyodide.http import pyfetch
                    await (await pyfetch("wasm_stuff.zip")).unpack_archive()
                    shutil.move("./cpy_wasm_cache", "/tmp")
                    print("Downloaded ‚òæ")`);
                for(const x of ["regex"]) {
                    log(`Installing ${x}‚Ä¶`);
                    await py.loadPackage(x);
                    log(`Installed ${x}`); }
                await py.runPythonAsync(`
                    from refresher import run_moon
                    from util import SCRIPT
                    ùëì, ùëê = run_moon(["--code_cache_dir=/tmp/cpy_wasm_cache/code",
                                     "--gram_cache_dir=/tmp/cpy_wasm_cache/gram"],
                                     extract_interactive=True)
                    ùëê("""
                    Û∞Ü¥ __header_namespace__["__error_printer__"]
                    Û∞Ü¥         __builtins__["__error_printer__"]""")
                    print("‚òæ Ready!")
                    print("ctrl + <enter>          Û∑∫Ñ Run multiline code")
                    print("alt  + <‚Üë/‚Üì>            Û∑∫Ñ Cycle history")
                    print("alt  + <l>              Û∑∫Ñ Clear screen")
                    print("alt  + <w/s/x or ,/./;> Û∑∫Ñ Superscript/subscript/normalize selection")`);
                let P = new URLSearchParams(window.location.search).get("code");
                if(P) {
                    log_as_user(P);
                    safeRunMoon(P); } };
            
            (async _ => {
                log("Loading Symbol Table‚Ä¶");
                const docs = await (await fetch("docs")).json();
                Object.entries(docs).forEach(([k,v]) => {
                    const Œµ = reformt(k);
                    Œµ.title = v[0];
                    syt.appendChild(Œµ);
                    Œµ.onclick = _ => caret_write(cli, QS("text:not(:has(> *))", Œµ).innerText); });
                log("Loaded Symbol Table");
                await load_python(); })();
                
            const …ô = e => (e.preventDefault(), auto_grow(cli));
            cli.addEventListener("keydown", async e => {
                const [[RŒ±, CŒ±], [Rœâ, Cœâ]] = sel_rc(cli);
                let val = cli.value;
                
                ùïí:if(e.altKey || !val) {
                    switch(e.keyCode) {
                        case 38: hist_p=Math.max(hist_p-1,             0); break  ;
                        case 40: hist_p=Math.min(hist_p+1, hist.length-1); break  ;
                        default:                                           break ùïí; }
                    return cli.value = hist[hist_p], …ô(e); }
                hist[hist_p = hist.length-1] = cli.value;
                
                if(e.key != "Enter") {
                    if(e.ctrlKey) {
                        switch(e.key) {
                            case '[': indent(cli, -1); break;
                            case ']': indent(cli,  1); break;
                            default : return; }
                        return …ô(e); }
                    if(e.altKey || navigator.platform.indexOf('Mac') > -1 && e.metaKey) {
                        switch(e.key) {
                            case 'l': QSA("div", ets).forEach(x => x.remove()); break;
                            case '.':
                            case 'w': replace_selection(cli, x=>script(x, "sup")); break;
                            case ',':
                            case 's': replace_selection(cli, x=>script(x, "sub")); break;
                            case ';':
                            case 'x': replace_selection(cli, x=>script(x, "nrm")); break;
                            default : return; }
                        return …ô(e); }
                    if(e.keyCode == 9) {
                        if     (e.shiftKey) indent(cli, -1);
                        else if(RŒ± == Rœâ  ) caret_write(cli, "    ");
                        else                indent(cli,  1);
                        return …ô(e); }
                    return; }
                
                if(!e.ctrlKey && (e.shiftKey || val.includes('\n'))) {
                    const bksp = Œµ => Œµ.dispatchEvent(
                        new KeyboardEvent('keydown', {
                            key: 'Backspace',
                            code: 'Backspace',
                            cancelable: false }));
                    if(RŒ±!=Rœâ || CŒ±!=Cœâ) bksp(cli);
                    enter_preserve_indent(cli);
                    return …ô(e); }
                
                log_as_user(val);
                cli.value = '', cli.style.minHeight = "1.1em";
                try      { safeRunMoon(val); }
                catch(e) { log(`Pyodide error! ${e}`); }
                …ô(e); });
        </script>
    </body>
</html>