<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
        <style>
            @font-face {
                font-family: 'JuliaMonoCustom';
                src: url('font.ttf') format('truetype');
            }
            * {
                box-sizing: border-box;
                overflow-wrap: anywhere;
                text-wrap: wrap;
                font-size: 25px;
                font-family: 'JuliaMonoCustom' !important;
            }
            
            ::-webkit-scrollbar { width: 12px; }
            ::-webkit-scrollbar-track { background: #000; }
            ::-webkit-scrollbar-thumb {
                background-color: #808080;
                border-radius: 10px;
                border: 3px solid #000; }
            * { scrollbar-width: thin;
                scrollbar-color: #808080 #000; }
            
            html, body {
                background: #000;
                color: #fff;
                display: flex;
                flex-direction: row;
                width: 100%; height: 100%;
                margin: 0%; padding: 0%;
                align-items: center;
                align-content: center;
                justify-content: center;
            }
            #entries {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 70%;
                height: 95%;
                overflow-y: scroll;
                border: 1px solid #fff;
                border-radius: 2px;
            }
            .entry, textarea {
                border: none;
                width: 100%;
                margin: 0px;
                padding: 0px; padding-left: 2px; padding-right: 2px;
                white-space: pre;
            }
            textarea {
                resize: none;
                overflow: hidden;
                background: #112;
                color: #fff;
                caret-color: #939;
                outline: none;
                height: 1.1em;
                min-height: 1.1em;
            }
            #symbolTable {
                display: flex;
                flex-direction: column-reverse;
                flex-wrap: wrap-reverse;
                align-items: center;
                justify-content: center;
                max-height: 100%;
                overflow-x: scroll;
                overflow-y: hidden;
                user-select: none;
                float: right;
            }
            #symbolTable > text:hover  * { background: #102; }
            #symbolTable > text:active * { background: #214; }
            #symbolTable > text:hover {
                transform: scale(1.075);
                cursor: pointer;
            }
            #symbolTable > text:active {
                transform: scale(1.150);
            }
            #symbolTable text {
                display: block;
                width: 35px;
                aspect-ratio: 1;
                align-content: center;
            }
            #symbolTable text:not(:has(> *)) {
                border: 0.5px solid #222;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="entries">
            <textarea id="cli_in" spellcheck="false" class="entry" style="height:1em" oninput="auto_grow(this)"></textarea>
        </div>
        <div id="symbolTable"></div>
        <script type="text/javascript">
            const ets = document.getElementById("entries");
            const cli = document.getElementById("cli_in");
            const syt = document.getElementById("symbolTable");
            ets.onclick = _ => cli.focus();
            const reformt = s => {
                const ùëì = (x, ...ùî∏) => {
                    const Œµ = document.createElement("text");
                    const hasStyle = x.length && x[0] == "\x1c";
                    if(hasStyle)
                        Œµ.style = x.slice(1);
                    else
                        Œµ.innerText = x;
                    if(ùî∏.length) {
                        const Œ≥ = ùëì(...ùî∏);
                        if(!hasStyle && !x) return Œ≥;
                        if(Œ≥.innerText) Œµ.appendChild(Œ≥);
                    }
                    return Œµ; };
                return ùëì(...("[0m"+s).replace(/\x1b\[(38|48);2;([0-9]{0,3});([0-9]{0,3});([0-9]{0,3})m/gm,
                                               (_,t,r,g,b)=>"\x1b\x1c"+`${t=="38"?"color":"background-color"}:#${(256*(256*Number(r)+Number(g))+Number(b)).toString(16).padStart(6, '0')}\x1b`)
                                      .replace(/\033\[0m/gm,
                                               "\x1b\x1c"+"color:#fff;background-color:#000\x1b")
                                      .split("\x1b")); };
            
            const log = x => {
                console.log(`Logging: "${x}"`);
                const Œµ = document.createElement("div");
                Œµ.className = "entry";
                Œµ.appendChild(reformt(x));
                ets.insertBefore(Œµ, cli);
                setTimeout(_ => { cli.scrollIntoView(); cli.focus(); }, 25);
                return x; }
            
            const auto_grow = Œµ => {
                Œµ.style.height = "5px";
                Œµ.style.height = Œµ.scrollHeight + "px"; };
            
            var py;
            (async _ => {
                log("Loading Symbol Table‚Ä¶");
                const docs = await (await fetch("docs")).json();
                Object.entries(docs).forEach(([k,v]) => {
                    const Œµ = reformt(k);
                    syt.appendChild(Œµ);
                    Œµ.onclick = _ => { cli.value += Œµ.querySelector("text:not(:has(> *))").innerText; }; });
                log("Loaded Symbol Table");
                
                log("Loading WASM Python‚Ä¶");
                py = await loadPyodide({ stdin: prompt, stdout: log, stderr: log });
                log("Loaded WASM Python");
                
                for(const x of ["more-itertools", "regex"]) {
                    log(`Installing ${x}‚Ä¶`);
                    await py.loadPackage(x);
                    log(`Installed ${x}`); }
                await py.runPythonAsync(`
                    import shutil
                    from pyodide.http import pyfetch
                    await (await pyfetch("wasm_stuff.zip")).unpack_archive(extract_dir="/tmp/")
                    print("Installed ‚òæ")`);
                await py.runPythonAsync(`
                    from refresher import run_moon
                    import sys
                    try   : del sys.excepthook
                    except: pass
                    ùëì = run_moon(["code_cache_dir=/tmp/cpy_wasm_cache/code",
                                  "gram_cache_dir=/tmp/cpy_wasm_cache/gram"], extract_interactive=True)
                    print("Ready!")`); })();
                
                cli.addEventListener("keydown", async e => {
                    if (e.key != "Enter") return;
                    if (e.shiftKey) return;
                    e.preventDefault();
                    let v = cli.value; cli.value = "";
                    cli.style.minHeight = "1.1em";
                    log(v);
                    v = v.replaceAll("\\", "\\\\").replaceAll('"', '\\"').replaceAll("\n", "\\n");
                    try {
                        py.runPython(`
                            try:
                                ùëì("${v}")
                            except Exception as e:
                                print("Error:", e)`);
                    } catch(e) { log(`Error! ${e}`); }
                });
        </script>
    </body>
</html>