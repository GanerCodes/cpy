var py, hist=[á¦], hist_p=0;
Â© [ets, cli, syt] = ["entries", "cli_in", "symbolTable"]ôŠ¾¡(GID)
Â© script = â¥Œx,mâ†¦py.globals.get("SCRIPT")â‚˜(x);

Â© safeRunMoon = â¥Œvalâ†¦py.runPython(â€¹
    try:
        ğ‘“(âŸ¦val.replaceAll(â¦‹/[\\"\n]/gâ¦Œ, ó°²¡({'\\':â€¹\\â€º,'\n':â€¹â›\ğ—»â€º,'"':â€¹\"â€º})â‚“)âŸ§)
    except Exception as e:
        print("Error:", e)â€º);

î¬¦ mfw "â„š".length Â¬â‰¡ "ğ•Š".length
Â© á”s = ó°²¡[â ¤x].slice(â ¤ğ”¸).join(á¦);
Â© á”ğ‘™ = ó°²¡[â ¤x].length;

Â© p2rc = â¥Œs,   ğ‘  â†¦{
    â‰ r=0, c=0, i=0, S=[â ¤s];
    âˆ€(g=0; i < ğŸƒŒ(S); g+=ğŸƒŒ(Sáµ¢â‚Šâ‚Š)) {
        Â¿( g â‰¡ ğ‘) â‡¥;
        Â¿(Sáµ¢ â‰¡ ğ—») r++, c=0;
        Â¡         c++; }
    â†ª [r,c]; };
Â© rc2p = â¥Œs, [ğ‘Ÿ,ğ‘]â†¦{
    â‰ r=0, c=0, i=0, S=[â ¤s];
    âˆ€(; i < ğŸƒŒ(S); i++) {
        Â¿(câ‰¡ğ‘ âˆ§ râ‰¡ğ‘Ÿ) â‡¥;
        Â¿(   Sáµ¢ â‰¡ ğ—») r++, c=0;
        Â¡            c++; }
    â†ª ğŸƒŒ(S.slice(0,i)ôŒ¿‘(á¦)); };
Â© sel_p  = â¥ŒÎµâ†¦[Îµ.selectionStart, Îµ.selectionEnd];
Â© sel_rc = â¥ŒÎµâ†¦sel_p(Îµ).map(ó°²¡p2rc(Îµ.value, x));
Â© caret_write = â¥ŒÎµ,tâ†¦{
    Îµ.focus();
    Â© [l,r] = sel_p(Îµ);
    Îµ.setRangeText(t, l, r, "select");
    Â¿(l â‰¡ r) Îµ.setSelectionRange(l+ğŸƒŒ(t), l+ğŸƒŒ(t)); }
Â© replace_selection = â¥ŒÎµ,ğ‘“â†¦{
    Â© [l,r] = sel_p(Îµ);
    Â© v = Îµ.value
    Â© x = v.slice(l, r);
    Â© X = ğ‘“(x);
    Îµ.value = v.slice(0, l) + X + v.slice(r);
    Îµ.setSelectionRange(l, l+ğŸƒŒ(X)); };
Â© indent = â¥ŒÎµ,num=1,nspace=4â†¦{
    Â© L = Îµ.value.split(ğ—»);
    â‰ [[RÎ±, CÎ±], [RÏ‰, CÏ‰]] = sel_rc(cli);
    â‰ rows = L.slice(RÎ±, RÏ‰+1);
    â‰ Î”c = {};
    
    Â© wrap = â¥Œğ‘“â†¦â¥Œx,iâ†¦(Î”c[RÎ±+i] = á”ğ‘™(r=ğ‘“(x))-á”ğ‘™(x), r);
    Â¿(num > 0) {
        Â© pad = ğ˜€.repeat(nspace*num);
        rows = rows.map(wrap(ó°²¡pad + x));
    }â¸˜(num < 0) {
        î¬¦ Â© ğ”¯ = new RegExp(String.rawâ€¹^ âŸ¦0,âŸ¦-num*nspaceâŸ§âŸ§â€º, â›g);
        rows = rows.map(wrap(ó°²¡x.replace(ğ”¯, á¦))); }
    
    L.splice(RÎ±, RÏ‰-RÎ±+1, â ¤rows);
    Îµ.value = LôŒ¿‘(ğ—»);
    CÎ± += Î”có°‚¤ó°ƒ¤;
    CÏ‰ += Î”có°‚¤ó°ƒ¼;
    Â© [pÎ±, pÏ‰] = [[RÎ±, CÎ±], [RÏ‰, CÏ‰]]ôŠ¾¡(ó°²¡rc2p(Îµ.value, x));
    Îµ.setSelectionRange(pÎ±, pÏ‰); };
Â© enter_preserve_indent = (Îµ) => {
    Â© L = Îµ.value.split(ğ—»);
    â‰ [[RÎ±, CÎ±], [_, __]] = sel_rc(cli);
    Â© [Î±,Î²] = [á”s(L[RÎ±], 0, CÎ±), á”s(L[RÎ±], CÎ±)];
    Â© ind = Î±.match(â¦‹/^ */â¦Œ)â‚€;
    L.splice(RÎ±, 1, Î±, ind+Î²);
    Îµ.value = L.join(ğ—»);
    Â© p = rc2p(Îµ.value, [RÎ±+1, ğŸƒŒ(ind)]);
    Îµ.setSelectionRange(p, p); };

Â© reformt = s => {
    Â© ğ‘“ = (x, â ¤ğ”¸) => {
        Â© Îµ = ó±€ text
        Â© hasStyle = ğŸƒŒ(x) âˆ§ xâ‚€ â‰¡ "\x1c";
        hasStyle â­œÎµô‹›Ÿ=x.slice(1)â­ Îµô‹’·=x;
        Â¿(ğŸƒŒ(ğ”¸)) {
            Â© Î³ = ğ‘“(â ¤ğ”¸);
            Â¿(Â¬hasStyle âˆ§ Â¬x) â†ª Î³;
            Â¿(Î³ô‹’·) Îµôª™(Î³); }
        â†ª Îµ; };
    â†ª ğ‘“(â ¤("[0m"+s).replace(â¦‹/\x1b\[(38|48);2;([0-9]{0,3});([0-9]{0,3});([0-9]{0,3})m/gmâ¦Œ,
                                   â¥Œ_,t,r,g,bâ†¦"\x1b\x1c"+â€¹âŸ¦tâ‰¡"38"?"color":"background-color"âŸ§:#âŸ¦
                                        (256*(256*ğ‘–(r)+ğ‘–(g))+ğ‘–(b)).toString(16).padStart(6, â›0)âŸ§âŸ¦"\x1b"âŸ§â€º)
                          .replace(â¦‹/\033\[0m/gmâ¦Œ,
                                   "\x1b\x1c"+"color:#fff;background-color:#000\x1b")
                          .split("\x1b")); };

Â© log = ó°²¡{
    â˜¾(â€¹Logging: "âŸ¦xâŸ§"â€º);
    Â© Îµ = document.createElement("div");
    Îµ.className = "entry";
    Îµôª™(reformt(x));
    ets.insertBefore(Îµ, cli);
    setTimeout(ğš²{ cli.scrollIntoView(); cli.focus(); }, 25);
    â†ª x; }

Â© log_as_user = x => {
    log(x);
    histô‹˜²ô‹˜²â‚•áµ¢â‚›â‚œô‹•â‚š = x;
    histâ‚Šâ‚Šâ‚•áµ¢â‚›â‚œô‹•â‚š = á¦; };

Â© run_shortcut = (Îµ, k) => Îµ.dispatchEvent(
    new KeyboardEvent("keydown", {
        key: k, code: "Key"+k.toUpperá‚(),
        altKey: âœ“, bubbles: âœ“, cancelable: âœ“ }));
Â© auto_grow = â¥ŒÎµâ†¦(Îµô‹›Ÿ.minHeight = "1em",
                  Îµô‹›Ÿ.minHeight = â€¹âŸ¦â¤‰(5, Îµ.scrollHeight)âŸ§pxâ€º,
                  Îµ.scrollIntoViewIfNeeded());

Â© load_python = async ğš²{
    log(â€¹Loading WASM Pythonâ€¦â€º);
    Â© { loadPyodide } = ó±«¬ import(â€¹https://cdn.jsdelivr.net/pyodide/v0.27.2/full/pyodide.mjsâ€º);
    py = ó±«¬ loadPyodide({ stdin: prompt, stdout: log, stderr: log  });
    log(â€¹Loaded WASM Pythonâ€º);
    ó±«¬ py.runPythonAsync(â€¹
        import shutil
        from pyodide.http import pyfetch
        await (await pyfetch("wasm_stuff.zip")).unpack_archive()
        shutil.move("./cpy_wasm_cache", "/tmp")
        print("Downloaded â˜¾")â€º);
        log(â€¹Installing regexâ€¦â€º);
        ó±«¬ py.loadPackage(x);
        log(â€¹Installed regexâ€º);
    ó±«¬ py.runPythonAsync(â€¹
        from refresher import run_moon
        from util import SCRIPT
        ğ‘“, ğ‘ = run_moon(["--code_cache_dir=/tmp/cpy_wasm_cache/code",
                         "--gram_cache_dir=/tmp/cpy_wasm_cache/gram"],
                         extract_interactive=True)
        ğ‘("""
        ó°†´ __header_namespace__["__error_printer__"]
        ó°†´         __builtins__["__error_printer__"]""")
        print("â˜¾ ReadyÂ¬")
        print("ctrl + <enter> ó·º„ Run multiline code")
        print("alt  + <â†‘/â†“>   ó·º„ Cycle history")
        print("alt  + <l>     ó·º„ Clear screen")
        print("alt  + <w/s/x> (mac: cmd+<,/./;>)")
        print("     ó·º„ Superscript/subscript/normalize selection")â€º);
        
    â‰ P = new URLSearchParams(window.location.search).get("code");
    Â¿(P) { log_as_user(P);
           safeRunMoon(P); } };

(async _ => {
    log(â€¹Loading Symbol Tableâ€¦â€º);
    Â© docs = ó±«¬ (ó±«¬ fetch("docs")).json();
    Object.entries(docs)ô‹ƒ(([k,v]) => {
        Â© Îµ = reformt(k);
        Îµ.title = vâ‚€;
        sytôª™(Îµ);
        Îµ.onclick = ğš²caret_write(cli, QS("text:not(:has(> *))", Îµ)ô‹’·); });
    log(â€¹Loaded Symbol Tableâ€º);
    ó±«¬ load_python(); })();
    
Â© É™ = â¥Œeâ†¦(e.preventDefault(), auto_grow(cli));
cli.addEventListener("keydown", ó±Ÿ± e => {
    Â© [[RÎ±, CÎ±], [RÏ‰, CÏ‰]] = sel_rc(cli);
    â‰ val = cli.value;
    
    ğ•’:Â¿(e.altKey âˆ¨ Â¬val) {
        âŒ¾(e.keyCode) {
            á‚ 38: hist_p=â¤‰(hist_p-1,         0); â‡¥  ;
            á‚ 40: hist_p=â¤ˆ(hist_p+1, ğŸƒŒ(hist)-1); â‡¥  ;
            âŠ³   :                                â‡¥ ğ•’; }
        â†ª cli.value = hist[hist_p], É™(e); }
    hist[hist_p = ğŸƒŒ(hist)-1] = cli.value;
    
    Â¿(e.key â‰  "Enter") {
        Â¿(e.ctrlKey) {
            âŒ¾(e.key) {
                á‚ â›[: indent(cli, -1); â‡¥;
                á‚ â›]: indent(cli,  1); â‡¥;
                âŠ³   : â†ª; }
            â†ª É™(e); }
        
        Â© mac = navigator.platform.includes('Mac') âˆ§ e.metaKey;
        Â© oth = e.altKey;
        Â¿(mac âˆ¨ oth) {
            Â© keys = [â ¤mac ?"l.,;": "lwsx"];
            âŒ¾(e.key) {
                á‚ keysâ‚€: QSA("div", ets)ô‹ƒ(ó°²¡x.remove()); â‡¥;
                á‚ keysâ‚: replace_selection(cli, ó°²¡script(x, "sup")); â‡¥;
                á‚ keysâ‚‚: replace_selection(cli, ó°²¡script(x, "sub")); â‡¥;
                á‚ keysâ‚ƒ: replace_selection(cli, ó°²¡script(x, "nrm")); â‡¥;
                âŠ³      : â†ª; }
            â†ª É™(e); }
        Â¿(e.keyCode â‰¡ 9) {
            Â¿(e.shiftKey) indent(cli, -1);
            â¸˜(RÎ± â‰¡ RÏ‰)    caret_write(cli, "    ");
            Â¡             indent(cli,  1);
            â†ª É™(e); }
        â†ª; }
    
    Â¿(Â¬e.ctrlKey âˆ§ (e.shiftKey âˆ¨ val.includes(ğ—»))) {
        Â© bksp = â¥ŒÎµâ†¦Îµ.dispatchEvent(
            ğŸ†• KeyboardEvent("keydown", {
                key: "Backspace", code: "Backspace",
                cancelable: âœ— }));
        Â¿(RÎ±â‰ RÏ‰ âˆ¨ CÎ±â‰ CÏ‰) bksp(cli);
        enter_preserve_indent(cli);
        â†ª É™(e); }
    
    log_as_user(val);
    cli.value = á¦, cliô‹›Ÿ.minHeight = "1.1em";
    try      { safeRunMoon(val); }
    catch(e) { log(â€¹Pyodide error! âŸ¦eâŸ§â€º); }
    É™(e); });