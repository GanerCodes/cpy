var py, hist=[á¦], hist_p=0;
Â© [ets, cli, syt] = ["entries", "cli_in", "symbolTable"]ôŠ¾¡(GID)
Â© script    = ó°²£py.globals.get("SCRIPT")î “(x);
Â© tofrac    = ó°²¡py.globals.get("TOFRAC") (x);
Â© flippy    = ó°²¡py.globals.get("UPSIDEDOWNSYNDROME")á¶ Ë¡â±áµ–(x);
Â© highlight = ó°²¡py.globals.get("highlight")(x);

Â© safeRunMoon = â¥Œvalâ†¦py.runPython(â˜¾(â€¹
try:
    ğ‘“("âŸ¦val.replaceAll(â¦‹/[\\"\n]/gâ¦Œ, ó°²¡({"\\":"\\\\","\n":"\\n",'"':'\\"'})â‚“)âŸ§")
except Exception as e:
    print("Error:", e)â€º));

î¬¦ mfw "â„š".length Â¬â‰¡ "ğ•Š".length
Â© á”s = ó°²¡[â ¤x].slice(â ¤ğ”¸).join(á¦);
Â© á”ğ‘™ = ó°²¡[â ¤x].length;

â¦‹esc2clr = s => {
    const TERM_RESET = "\x1b[0m";
    if(s.includes(TERM_RESET))
        return s.split(TERM_RESET).map(esc2clr).reduce((x,y)=>[...x,...y],[]);
    s = s.replaceAll(/\x1b\[38;2;([0-9]+);([0-9]+);([0-9]+)m/g, (...ğ”¸)=>`\x01${ğ”¸.slice(1,4).map(x=>x.padStart(3,'0')).join('')}`);
    s = s.replaceAll(/\x1b\[48;2;([0-9]+);([0-9]+);([0-9]+)m/g, (...ğ”¸)=>`\x02${ğ”¸.slice(1,4).map(x=>x.padStart(3,'0')).join('')}`);
    s = [...s];
    ğš‚ = [[255,255,255],[0,0,0]];
    ğš = [];
    while(s.length) {
        const c = s.splice(0,1)[0];
        if(c == '\x01' || c=='\x02')
            ğš‚[c=='\x02'?1:0] = [0,0,0].map(_=>Number(s.splice(0,3).join('')));
        else
            ğš.push([c,...ğš‚]); }
    return ğš; }â¦Œ

Â© p2rc = â¥Œs,   ğ‘  â†¦{
    â‰ r=0, c=0, i=0, S=[â ¤s];
    âˆ€(g=0; i < ğŸƒŒ(S); g+=ğŸƒŒ(Sáµ¢â‚Šâ‚Š)) {
        Â¿( g â‰¡ ğ‘) â‡¥;
        Â¿(Sáµ¢ â‰¡ ğ—») r++, c=0;
        Â¡         c++; }
    â†ª [r,c]; };
Â© rc2p = â¥Œs, [ğ‘Ÿ,ğ‘]â†¦{
    â‰ r=0, c=0, i=0, S=[â ¤s];
    âˆ€(; i < ğŸƒŒ(S); i++) {
        Â¿(câ‰¡ğ‘ âˆ§ râ‰¡ğ‘Ÿ) â‡¥;
        Â¿(   Sáµ¢ â‰¡ ğ—») r++, c=0;
        Â¡            c++; }
    â†ª ğŸƒŒ(S.slice(0,i)ôŒ¿‘(á¦)); };
Â© sel_p  = â¥ŒÎµâ†¦[Îµ.selectionStart, Îµ.selectionEnd];
Â© sel_rc = â¥ŒÎµâ†¦sel_p(Îµ).map(ó°²¡p2rc(Îµ.value, x));
Â© caret_write = â¥ŒÎµ,tâ†¦{
    Îµ.focus();
    Â© [l,r] = sel_p(Îµ);
    Îµ.setRangeText(t, l, r, "select");
    Â¿(l â‰¡ r) Îµ.setSelectionRange(l+ğŸƒŒ(t), l+ğŸƒŒ(t)); }
Â© replace_selection = â¥ŒÎµ,ğ‘“â†¦{
    Â© [l,r] = sel_p(Îµ);
    Â© v = Îµ.value
    Â© x = v.slice(l, r);
    Â© X = ğ‘“(x);
    Îµ.value = v.slice(0, l) + X + v.slice(r);
    Îµ.setSelectionRange(l, l+ğŸƒŒ(X)); };
Â© indent = â¥ŒÎµ,num=1,nspace=4â†¦{
    Â© L = Îµ.value.split(ğ—»);
    â‰ [[RÎ±, CÎ±], [RÏ‰, CÏ‰]] = sel_rc(cli);
    â‰ rows = L.slice(RÎ±, RÏ‰+1);
    â‰ Î”c = {};
    
    Â© wrap = â¥Œğ‘“â†¦â¥Œx,iâ†¦(Î”c[RÎ±+i] = á”ğ‘™(r=ğ‘“(x))-á”ğ‘™(x), r);
    Â¿(num > 0) {
        Â© pad = ğ˜€.repeat(nspace*num);
        rows = rows.map(wrap(ó°²¡pad + x));
    }â¸˜(num < 0) {
        Â© ğ”¯ = new RegExp(â¦‹String.raw`^ {0,${-num*nspace}}`â¦Œ, â›g);
        rows = rows.map(wrap(ó°²¡x.replace(ğ”¯, á¦))); }
    
    L.splice(RÎ±, RÏ‰-RÎ±+1, â ¤rows);
    Îµ.value = LôŒ¿‘(ğ—»);
    CÎ± += Î”có°‚¤ó°ƒ¤;
    CÏ‰ += Î”có°‚¤ó°ƒ¼;
    Â© [pÎ±, pÏ‰] = [[RÎ±, CÎ±], [RÏ‰, CÏ‰]]ôŠ¾¡(ó°²¡rc2p(Îµ.value, x));
    Îµ.setSelectionRange(pÎ±, pÏ‰); };
Â© enter_preserve_indent = (Îµ) => {
    Â© L = Îµ.value.split(ğ—»);
    â‰ [[RÎ±, CÎ±], [_, __]] = sel_rc(cli);
    Â© [Î±,Î²] = [á”s(L[RÎ±], 0, CÎ±), á”s(L[RÎ±], CÎ±)];
    Â© ind = Î±.match(â¦‹/^ */â¦Œ)â‚€;
    L.splice(RÎ±, 1, Î±, ind+Î²);
    Îµ.value = L.join(ğ—»);
    Â© p = rc2p(Îµ.value, [RÎ±+1, ğŸƒŒ(ind)]);
    Îµ.setSelectionRange(p, p); };

Â© reformt = â¥Œsâ†¦{
    Â© hex =  ó°²¡â›#+xôŠ¾¡(ó°²¡x.toString(16).padStart(2,â›0)).join(á¦);
    Â© ğ™² = esc2clr(s)ôŠ¾¡(ó°²¡ó±€ text {ğ‘† â€¹color:âŸ¦hex(xâ‚)âŸ§;background-color:âŸ¦hex(xâ‚‚)âŸ§;â€º} âŸ¦xâ‚€âŸ§);
    â†ª ó±€ text âŸ¦ğ™²âŸ§; };
    î¬¦ â†ª ğŸƒŒ(ğ™²)â‰¡1 â­œğ™²â‚€â­ (ó±€ text âŸ¦ğ™²âŸ§); };

Â© log = ó°²¡{
    â˜¾(â€¹Logging: "âŸ¦xâŸ§"â€º);
    Â© Îµ = document.createElement("div");
    Îµ.className = "entry";
    Îµôª™(reformt(x));
    ets.insertBefore(Îµ, cli);
    setTimeout(ğš²{ cli.scrollIntoView(); cli.focus(); }, 25);
    â†ª x; }

Â© log_as_user = ó°²¡{
    log(x);
    histô‹˜²ô‹˜²â‚•áµ¢â‚›â‚œô‹•â‚š = x;
    histâ‚Šâ‚Šâ‚•áµ¢â‚›â‚œô‹•â‚š = á¦; };

Â© run_shortcut = â¥ŒÎµ, kâ†¦Îµ.dispatchEvent(
    new KeyboardEvent("keydown", {
        key: k, code: "Key"+k.toUpperCase(),
        altKey: âœ“, bubbles: âœ“, cancelable: âœ“ }));
Â© auto_grow = â¥ŒÎµâ†¦(Îµô‹›Ÿ.minHeight = "1em",
                  Îµô‹›Ÿ.minHeight = â€¹âŸ¦â¤‰(5, Îµ.scrollHeight)âŸ§pxâ€º,
                  Îµ.scrollIntoViewIfNeeded());

Â© load_python = ó±Ÿ± ğš²{
    log(â€¹Loading WASM Pythonâ€¦â€º);
    Â© { loadPyodide } = ó±«¬ import(â€¹https://cdn.jsdelivr.net/pyodide/v0.27.2/full/pyodide.mjsâ€º);
    py = ó±«¬ loadPyodide({ stdin: prompt, stdout: log, stderr: log  });
    log(â€¹Loaded WASM Pythonâ€º);
    ó±«¬ py.runPythonAsync(â€¹
        import shutil
        from pyodide.http import pyfetch
        await (await pyfetch("wasm_stuff.zip")).unpack_archive()
        shutil.move("./cpy_wasm_cache", "/tmp")
        print("Downloaded â˜¾")
        # ó±«¬ py.loadPackage("regex")â€º);
    ó±«¬ py.runPythonAsync(â€¹
        from refresher import run_moon, cpy_get_highlighter
        from util import SCRIPT, UPSIDEDOWNSYNDROME, TOFRAC
        ğ‘“, ğ‘ = run_moon(["--code_cache_dir=/tmp/cpy_wasm_cache/code",
                         "--gram_cache_dir=/tmp/cpy_wasm_cache/gram"],
                         extract_interactive=True)
        highlight = cpy_get_highlighter(ğ‘.ns)
        ğ‘("""
        î¬¦ ó°†´ __header_namespace__["__error_printer__"]
        î¬¦ ó°†´         __builtins__["__error_printer__"]
        "â˜¾ Ready!"                                         â˜¾
        "ctrl + <enter> ó·º„ Run multiline code"              â˜¾
        "alt  + <â†‘/â†“>   ó·º„ Cycle history"                   â˜¾
        "alt  + <l>     ó·º„ Clear screen"                    â˜¾
        "alt  + <=>     ó·º„ Flip number"                     â˜¾
        "alt  + </>     ó·º„ Selection to fraction"           â˜¾
        "alt  + <w/s/x> (mac: cmd+<,/./;>)"                â˜¾
        "     ó·º„ Superscript/subscript/normalize selection" â˜¾
        """)â€º);
        
    â‰ P = new URLSearchParams(window.location.search).get("code");
    Â¿(P) { log_as_user(P);
           safeRunMoon(P); } };

(async _ => {
    log(â€¹Loading Symbol Tableâ€¦â€º);
    
    ó±«¬ load_python();
    Â© styles = ó±«¬ (ó±«¬ fetch("style")).json();
    Â© docs   = ó±«¬ (ó±«¬ fetch("info" )).json();
    î¬¦ docsô‹ƒ(â¥Œ[x,y,z]â†¦ó±‘¼(x,y)ô‹ƒ(â¥Œ[x,y]â†¦{
    î¬¦     Â© Îµ = reformt(highlight(x));
    î¬¦     Îµ.title = y;
    î¬¦     sytôª™(Îµ);
    î¬¦     Îµ.onclick = ğš²caret_write(cli, Îµô‹’· âˆ¨ QS(â€¹*:not(text:has(> *))â€º, Îµ)ô‹’·); }));
    î¬¦ sytôª™(Îµ);
    
    docsô‹ƒ(â¥Œ[x,y,z]â†¦ {
        Â© symbs = ó±‘¼(x,y)ôŠ¾¡(â¥Œ[x,y]â†¦{
            Â© Îµ = reformt(highlight(x));
            Îµ.title = y;
            Îµ.onclick = ğš²caret_write(cli, Îµô‹’· âˆ¨ QS(â€¹*:not(text:has(> *))â€º, Îµ)ô‹’·);
            â†ª Îµ; });
        
        sytôª™(ğŸƒŒ(symbs)â‰¡1â­œsymbsâ‚€
                       â­ó±€ div {ğ¶ symbolGroup} âŸ¦symbsâŸ§);
    });
    
    log(â€¹Loaded Symbol Tableâ€º); })();
    
Â© É™ = â¥Œeâ†¦(e.preventDefault(), auto_grow(cli));
cli.addEventListener("keydown", ó±Ÿ± â¥Œeâ†¦{
    Â© [[RÎ±, CÎ±], [RÏ‰, CÏ‰]] = sel_rc(cli);
    â‰ val = cli.value;
    
    ğ•’:Â¿(e.altKey âˆ¨ Â¬val) {
        âŒ¾(e.keyCode) {
            á‚ 38: hist_p=â¤‰(hist_p-1,         0); â‡¥  ;
            á‚ 40: hist_p=â¤ˆ(hist_p+1, ğŸƒŒ(hist)-1); â‡¥  ;
            âŠ³   :                                â‡¥ ğ•’; }
        â†ª cli.value = hist[hist_p], É™(e); }
    hist[hist_p = ğŸƒŒ(hist)-1] = cli.value;
    
    Â¿(e.key â‰  "Enter") {
        Â¿(e.ctrlKey) {
            âŒ¾(e.key) {
                á‚ â›[: indent(cli, -1); â‡¥;
                á‚ â›]: indent(cli,  1); â‡¥;
                âŠ³   : â†ª; }
            â†ª É™(e); }
        
        Â© mac = navigator.platform.includes('Mac') âˆ§ e.metaKey;
        Â© oth = e.altKey;
        Â¿(mac âˆ¨ oth) {
            Â© keys = [â ¤mac ?"l.,;/=": "lwsx/="];
            âŒ¾(e.key) {
                á‚ keysâ‚€: QSA("div", ets)ô‹ƒ(ó°²¡x.remove()); â‡¥;
                á‚ keysâ‚: replace_selection(cli, ó°²¡script(x, "sup")); â‡¥;
                á‚ keysâ‚‚: replace_selection(cli, ó°²¡script(x, "sub")); â‡¥;
                á‚ keysâ‚ƒ: replace_selection(cli, ó°²¡script(x, "nrm")); â‡¥;
                á‚ keysâ‚„: replace_selection(cli, ó°²¡tofrac(x       )); â‡¥;
                á‚ keysâ‚…: replace_selection(cli, ó°²¡flippy(x       )); â‡¥;
                âŠ³      : â†ª; }
            â†ª É™(e); }
        Â¿(e.keyCode â‰¡ 9) {
            Â¿(e.shiftKey) indent(cli, -1);
            â¸˜(RÎ± â‰¡ RÏ‰)    caret_write(cli, "    ");
            Â¡             indent(cli,  1);
            â†ª É™(e); }
        â†ª; }
    
    Â¿(Â¬e.ctrlKey âˆ§ (e.shiftKey âˆ¨ val.includes(ğ—»))) {
        Â© bksp = â¥ŒÎµâ†¦Îµ.dispatchEvent(
            ğŸ†• KeyboardEvent("keydown", {
                key: "Backspace", code: "Backspace",
                cancelable: âœ— }));
        Â¿(RÎ±â‰ RÏ‰ âˆ¨ CÎ±â‰ CÏ‰) bksp(cli);
        enter_preserve_indent(cli);
        â†ª É™(e); }
    
    log_as_user(val);
    cli.value = á¦, cliô‹›Ÿ.minHeight = "1.1em";
    try      { safeRunMoon(val); }
    catch(e) { log(â€¹Pyodide error! âŸ¦eâŸ§â€º); }
    É™(e); });