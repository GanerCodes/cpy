â¨¡ regex as re
ó°‹º(â›ğ, *)

âŠ¢ parse(ğ·, ğ‘…, start_rule=â–¡):
    â„­, Ï‡ = ğ·ğŸƒŒ+1â†’â­¥á´ó°²¡{}, 0
    ğ“¢ = [(â–¡, ğ‘…ğŸƒŒ-1 Â¿start_ruleâ‰…â–¡Â¡ start_rule)]
    Ï‡ = 0
    â°ğ“¢:
        Î§, Î¹ = ğ“¢.pop(Â¯1)
        Â¿Î§â‰‡â–¡: Ï‡=Î§
        Î“ = Ï‡, Î¹
        Î³, â ¤ğ¶ = Ï‰ = ğ‘…ó°ƒ¬
        ğ”  = â„­ó°ƒº
        
        î¬¦ â€¹âŸ¦Ï‰=âŸ§ âŸ¦Î“=âŸ§â€ºâ˜¾
        
        Â¿Î³â‰¡â›á”:
            Â¿ğ¶â‚€â‰¡ğ·ó°ƒºï¹•ôŠ¸´ôŠ®ó°ƒºâ‚ŠôŠ³µôŠ¬£ôŠ¹³: ğ” ó°ƒ¬ = âœ“, ğŒ
            Â¡             : ğ” ó°ƒ¬ = âœ—, Ï‡
        â¸˜Î³â‰¡â›~:
            Â¿mâ‰”ğ¶â‚€.match(ğ·, Ï‡):
                ğ” ó°ƒ¬ = âœ“, Ï‡ + m.group(0)ğŸƒŒ, m
            Â¡:  ğ” ó°ƒ¬ = âœ—, Ï‡
        â¸˜Î³â‰¡â›âˆ§:
            n, ğŒ = ğ” ó°ƒ¬ Â¿Î¹âˆˆğ” Â¡ (0, Ï‡)
            â°âœ“:
                Â¿ğœ¾â‰”ğ¶â‚™ â†’âˆ‰â† ğ‘â‰”â„­ôŠ¸´:
                    ğ“¢.extend([Î“, (ğŒ, ğœ¾)])
                    ğ” ó°ƒ¬ = n, ğŒ ; â‡¥
                ğ‘”, ğŒ = â„­ôŠ¸´ ôŠ¸§ ï¹•â‚‚
                n = n + 1
                Â¿    ğ‘”Â¬: ğ” ó°ƒ¬ = âœ—, Ï‡ ; â‡¥
                Â¿n â‰¡ ğ¶ğŸƒŒ: ğ” ó°ƒ¬ = âœ“, ğŒ ; â‡¥
        â¸˜Î³â‰¡â›âˆ¨:
            n = ğ” ó°ƒ¬ Â¿Î¹âˆˆğ” Â¡ 0
            â°âœ“:
                Â¿ğœ¾â‰”ğ¶â‚™ â†’âˆ‰â† ğ‘â‰”â„­ó°ƒº:
                    ğ“¢.extend([Î“, (Ï‡, ğœ¾)])
                    ğ” ó°ƒ¬ = n ; â‡¥
                ğ‘”, ğŒ = â„­ó°ƒº ôŠ¸§ ï¹•â‚‚
                Â¿    ğ‘” : ğ” ó°ƒ¬ = âœ“, ğŒ, n ; â‡¥
                n += 1
                Â¿n â‰¡ ğ¶ğŸƒŒ: ğ” ó°ƒ¬ = âœ—, Ï‡    ; â‡¥
        â¸˜Î³âˆˆ{â›*, â›+}:
            c = ğ” .setdefault(Î¹, [Ï‡])
            ğœ¾, ğŒ = ğ¶â‚€, câ‚‹â‚
            â°âœ“:
                Â¿ğœ¾ â†’âˆ‰â† ğ‘â‰”â„­ôŠ¸´:
                    ğ“¢.extend([Î“, (ğŒ, ğœ¾)])
                    â‡¥
                ğ‘”, Î§ = â„­ôŠ¸´ ôŠ¸§ ï¹•â‚‚
                Â¿Â¬ğ‘”:
                    Â¿Î³â‰¡â›* âˆ¨ cğŸƒŒ>1:
                        ğ” ó°ƒ¬ = âœ“, ğŒ, cï¹•â‚‹â‚
                    â‡¥
                c.append(ğŒâ‰”Î§)
        â¸˜Î³â‰¡â›âœ“: ğ” ó°ƒ¬ = âœ“, Ï‡
        â¸˜Î³â‰¡â›âœ—: âœ—â¨³â€¹Hit an âœ—â€º
        â¸˜Î³â‰¡â›â†:
            Â¿ğ¶â‚âˆ‰ğ” :
                ğ“¢.extend([Î“, (Ï‡, ğ¶â‚)])
                â†º
            ğ‘”, ğŒ = ğ” ôŠ³µôŠ¬¤ ï¹•â‚‚
            ğ” ó°ƒ¬ = ğ‘”, ğŒ, ğ¶â‚
        Â¡:
            Â¿ğ¶â‚€âˆ‰ğ” :
                ğ“¢.extend([Î“, (Ï‡, ğ¶â‚€)])
                â†º
            ğ‘”, ğŒ = ğ” ôŠ³µôŠ¬£ ï¹•â‚‚
            Â¿Î³â‰¡â›â®: ğ” ó°ƒ¬ = ğ‘” , Ï‡
            â¸˜Î³â‰¡â›Â¬: ğ” ó°ƒ¬ = ğ‘”Â¬, Ï‡
            â¸˜Î³â‰¡â›â—: ğ” ó°ƒ¬ = ğ‘”â¨³, ğŒ
            â¸˜Î³â‰¡â›?: ğ” ó°ƒ¬ = âœ“ , ğŒ, ğ‘”
            Â¡    : ğ” ó°ƒ¬ = ğ‘” , ğŒ
    â†ª â„­

âŠ¢ make_rules(r):
    î¬¦ ó°¤± add option to skip jumping to declarations
    nmp = â„µ(râ»Î¶râ­¥)
    r = r êŸ¿á´· ó°²£â›_+x
    ğ‚ = â„µ(râ»Î¶ğ‘â‰”râ» á´ â›¶áµ€)
    âŠ¢ ğ•Š(r):
        Â¿rğŸƒŒâ‰¡1 âˆ§ râ‚€ â‚€â‰¡â›_: â†ª(râ‚€, )
        Â¿râˆˆğ‚: â†ª ğ‚áµ£
        Â¿râ‚€á¹ğ‘–: r = (ğ‘ôŠµ¬ôŠ®áµ£ôŠ¬£ â‚€, â ¤râ‚ï¹•)
        Â¡    : ğ‘.append(ğ”¦â‰”ğ‘ğŸƒŒ)
        Â¿râ‚€  â‰¡â›â†  : r = (râ‚€, râ‚, ğ•Š(râ‚‚))
        â¸˜râ‚€  âˆˆâ›âœ“â›âœ—: r = (râ‚€, ğ”¦)â˜¾
        â¸˜râ‚€  âˆ‰â›á”â›~: r = (râ‚€, â ¤râ‚ï¹• á´ ğ•Š)
        î¬¦ ğ‘ôŠ³ôŠ¬ôŠ®ôŠµ¬â‰”r î¬¦ BROKEN ó°¤± FIX â˜¾
        ğ‘ôŠ³ôŠ¬ôŠ®ôŠµ¬=r
        â†ª ğ”¦
    ğ•Š(("T_root", â ¤nmpâºÎ¶râº á´ ğ‘¡))
    ğ‘ = ğ‘ á´ ó°²¡(xâ‚€, â ¤xâ‚ï¹• á´ó°²¡ (râ»ó°‘…á´µ(â‰¡ï(xâ‚€)))Â¿xá¹ğ‘¡Â¡x)
    ğ‘â˜¾
    â†ª â„µô‹†’|nmp
show_cache_table = â¥Œğ‘…,â„­â†¦â†¨â„­êŸ¿â¥Œi,vâ†¦â„µ(v)î ó°’¼â†’êŸ¿ó°²£â˜¾â€¹âŸ¦iâŸ§,âŸ¦xâŸ§ğ˜âŸ¦ğ‘…â‚“âŸ§ğ˜âŸ¦yâŸ§â€º
âŠ¢ parse_to_tree(ğ‘…, â„­, â ¤ğ”¸, show_table=âœ—):
    Â¿ğ”¸ğŸƒŒâ‰¡2: Ï‡, Î¹ = ğ”¸
    Â¡    :
        Ï‡, Î¹ = 0, ğ”¸â‚€
        Â¿show_table: show_cache_table(ğ‘…, â„­)
    rec = parse_to_treeï(ğ‘…, â„­)
    Î³, â ¤C = ğ‘…ó°ƒ¬
    Â¿Î¹âˆ‰ğ” â‰”â„­ó°ƒº: â†ª Î³, â€¹â€¼âˆ„â€¼â€º
    ğ‘”, ğŒ, â ¤ğ´ = ğ” ó°ƒ¬
    î¬¦ ğ‘”â¨³â€¹Failed to parse tree!â€º
    
    Â¿Î³â‰¡â›âˆ§:
        o = []
        âˆ€râˆˆC:
            o.append(rec(Ï‡, r))
            Â¿râˆ‰ğ” â‰”â„­ó°ƒº: â‡¥
            Ï‡ = ğ” áµ£ â‚
        â†ª Î³, â ¤o
    Â¿Î³â‰¡â›á”: â†ª Î³, Câ‚€
    Â¿Â¬ğ´ âˆ§ Î³âˆˆ{â ¤â€¹âˆ¨?*+â€º}: â†ª Î³, â€¹â€¼âˆ…â€¼â€º
    Â¿Î³â‰¡â›~: â†ª Î³, ğ´â‚€.group(0)
    
    Â¿Î³â‰¡â›âˆ¨: â†ª Î³, rec(Ï‡, CôŠ³³ôŠ¬£)
    Â¿Î³â‰¡â›â†: â†ª Î³, Câ‚€, rec(Ï‡, ğ´â‚€)
    Â¿Î³â‰¡â›?: â†ª Î³, â ¤ğ´â‚€ âˆ§ rec(Ï‡, Câ‚€)â›¶áµ€ âˆ¨ ()
    Â¿Î³âˆˆ{â ¤â›*â›+}: â†ª Î³, â ¤ğ´â‚€ á´ recï(â¬¤, Câ‚€)
    Â¿Î³âˆˆ{â ¤â›âœ“â›âœ—}: â†ª Î³, 
    â†ª Î³.removeprefix(â›_), rec(Ï‡, Câ‚€)

âŠ¢ chop(ó±•, ğ·,
        remove_delete=âœ“,
        remove_failed_questions=âœ“,
        remove_lookaheads=âœ“):
    
    pops = â€¹âˆ§âˆ¨âœ“âœ—*+â—â ¶â€º + â›?â‹…remove_failed_questions â›
                      + â›â®â›Â¬â‹…remove_lookaheads
    ó±• = ó±• á£†Ê³áµ‰áµáµ’áµ›áµ‰ô‹•Ÿáµˆáµ‰Ë¡áµ‰áµ—áµ‰ â†Åƒ.filterï(â¬¤, ó°²¡xáµ—â‰ â›ó°†´)
    âŠ¢ reform_str(ó±•):
        ó±•áµ—, ó±•á¶œ, ó±•áµ‰ áµ€ = ó±•á¶œâ‚€áµ—, [], âœ“
        â†ª ó±•
    ó±•.ftrp(â›á”â›~, reform_str)
    
    ó±•.frp (â´³, ó°²¡xâ—„xá¶œâ‰”(x á´ó°²¡(xá´ó°²¡xá¶œó°…‚Î£[] Â¿xáµ—â‰¡â›â ¶Â¡ xá¶œ)Â¿xá¹Åƒâˆ§xáµ—âˆˆpopsÂ¡xâ›¶ó°…‚ Î£[]), pre=âœ“)
    
    âŠ¢ get_txt(ó±•):
        l = []
        ó±•.frp(ó°²¡xáµ‰ áµ€, ó°²¡l.append(xáµ—)â–ºx, pre=âœ“)
        â†ª lÎ£á¦
    ó±•.ftrp(â›Æ¨, ó°²¡Åƒ(get_txt(x), e=â„µ(T=âœ“)))
    
    âŠ¢ set_arrows(ó±•):
        âˆ€i,c âˆˆ ó±•â†¨:
            Â¿cáµ—â‰¡â›â†:
                ó±•áµ‰î ôŠ¬£ôŠ«¼ = ó±•áµ¢ = câ‚
            set_arrows(c)
    set_arrows(ó±•)
    
    "tord"â˜¾, tord(ó±•).printî®¦
    â†ª ó±•

âŠ¢ tord(ó±•):
    âŠ¢ tord(ó±•):
        s = â„µ()
        âˆ€k,v âˆˆ ó±•áµ‰:
            Â¿kâ‰¡â›T: â†ª Node(c=ó±•áµ—)
            sô‹‘ºôŠ¬„ô‹•œáµ¢â‚™î â‚‘â‚“â‚áµ¥â‚ = k
        c = ó±•á´tord
        âˆ€i,vâˆˆs: cáµ¢áµ‰ = v
        â†ª Node(ó±•áµ—, c)
    ó±• = tord(ó±•)
    ó±• = ó±•.find_replace(nâ†¦nğŸƒŒâ‰¡1 âˆ§ (Î²â‰”ná¶œâ‚€)á¹Node âˆ§ Â¬Î²áµ—,
                       nâ†¦n.copy(c=n.txt))
    â†ª ó±•

Parser = gâ†¦â„µ(
    rules=gâ‰”make_rules(g),
    parse=â¥Œc,r=â€¹mainâ€ºâ†¦
            parse_to_tree(
                g.T_root,
                parse(c, g.T_root, gáµ£),
                gáµ£, â ¶ğ•‚),
    chop=â¥Œc,ó±•â†¦chop(ó±•, c))

â®Œ peggle â¨¡ Parser as ppp, Node
p = ppp(ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
main    = ó°†´W? (entry ó°†´W?)*
entry   = (
    Æ¨(section=ó°†´'[' wrd ó°†´']') ó°†´W?
    (pair = (
        (bruh:key = â ¶wrd) ó°†´(w? â†· '=')
        (value = (wrd âˆ¨ str)+) ó°†´W? ) )* )

str     = ~â€¹"[^"]+"â€º
wrd     = ~â€¹[-\w]+â€º
w       = ~â€¹[ \t]+â€º
W       = ~â€¹[ \t\n]+â€º
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥)
ğ· = ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
[section]
somekey = somevalue
someotherkey=someothervalue
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥ * 1
î¬¦ [anothersection]
î¬¦ key123 = "swooce"
î¬¦ key456="yet another one here"
âŠ¢ conv(x):
    Â¿xáµ—â‰¡â›â†: â†ª (xáµ—, xâ‚€á¶œ, conv(xâ‚))
    Â¿xáµ—â‰¡"rname": â†ª (â›_â‹…(xá¶œâˆ‰â›âœ“â›âœ—)+xá¶œ, )
    â†ª xáµ—, â ¤((xá¶œ á´ conv) Â¿xá´¸Â¡ (xá¶œ, ))
rz = â„µ(p.rules) êŸ¿â±½ ó°²£conv(y)ó°…‚

prs = Parser(rz)
ó±• = (Æ’ â‰” ó°²¡Åƒ(x, â ¤ğ”¸á´ó°²¡Æ’(â ¤xÂ¿xá¹ğ‘¡Â¡xâ›¶áµ€)))(
        â ¤prs.parse(ğ·, show_table=âœ—))

"orig"â˜¾, p(ğ·).printî®¦
res = prs.chop(ğ·, ó±•)
"new"â˜¾, resá´¾î®¦â˜¾

exitî®¦
î¬¦ Æ’ = ó°²¡Node(x, ğ”¸á´ó°²¡Æ’(â ¤xÂ¿xá¹ğ‘¡Â¡xâ›¶áµ€))

î¬¦ hâ‰”prs.rules.T_rootâ†’â­¥Î¶hêŸ¿â˜¾Â´ï(sep=ğ˜)

exitî®¦

gram = â„µ(
    main=(â›âˆ§,
        (â›á”, "K"),
        (â›~, re.compile("a*ba*b*Z")),
        (â›á”, "K")))
content = ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥KaabaabbZKó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
prs = Parser(gram).parse(content) â˜¾



î¬¦ ó·¹‡ôŠ½¨ we can cache by (rule, str up-to-lookahead)