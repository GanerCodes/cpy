ğ”¦ğ”ªğ”­â†â›s ; ldirî®¦
â®Œ peggle â¨¡ Parser
â®Œ peggle â¨¡ Node
â¨¡ string as ğ’

pgram =       "gram"â¥‰ğ©
pcomp = "compose.âœâš™"â¥‰ğ©

symmap = {
    â›(: "parenleft"  , â›): "parenright"  ,
    â›{: "braceleft"  , â›}: "braceright"  ,
    â›[: "bracketleft", â›]: "bracketright",
    â›<: "less"       , â›>: "greater"     ,
    â›+: "plus"       , â›-: "minus"       ,
    â›/: "slash"      , â›\: "backslash"   ,
    â›!: "exclam"     , â›?: "question"    ,
    â›.: "period"     , â›,: "comma"       ,
    â›:: "colon"      , â›;: "semicolon"   ,
    â›&: "ampersand"  , â›%: "percent"     ,
    â›=: "equal"      , â›*: "asterisk"    ,
    â›_: "underscore" , â›|: "bar"         ,
    â›^: "asciicircum", â›~: "asciitilde"  ,
    â›#: "numbersign" , â›$: "dollar"      ,
    â›': "apostrophe" , â›": "quotedbl"    ,
    â›ğ•Š: "space"      , â›á´: "Multi_key"   ,
    â› : "space"      ,
    â ¶ğ‘‘(ğ’.ascii_letters+ğ’.digits á´ó°²¡xâ‹„êœ ) }

Î© ğ”¥:
    __init__ = ó°²£x.xâ‰”â†y.xÂ¿yá¹ğ”¥Â¡yâ†’â–ºâ–¡
    __iter__ = ó°²¡xâ›¶â¥‰iter
âŠ¢ gen_rule(n):
    Â¿náµ—â‰¡"letter": â†ªn.txt â¥‰ ğ”¥
    Â¿náµ—â‰¡"macref": â†ªmacs[n.txt]
    Â¿náµ—â‰¡"concat": â†ªná¶œ á´gen_rule â†’â¨‰â†’ á´ğ”¥
    Â¿náµ—â‰¡"looper": â†ªná¶œ á´gen_rule Å¿ó°ºó°» ó°²£x+(yâ›¶Â¿yá¹ğ”¥Â¡y)
p = pgramâ‹„pcompá´ó°²¡x.openî®¦.readî®¦ó°…‚ Å¿á´¾áµƒÊ³Ë¢áµ‰Ê³ âˆ˜ â›
      á´ó°²¡yâ‰”xá¶œâ†’â‚€â‹„(yâ‚á¶œá´ó°²¡x Â¿xá¹á”Â¡ x.txt)
macs = pó°ˆ²ó°²¡xâ‚€áµ—â‰¡"mac_head"ó°…‚ êŸ¿ó°²£(x.txt, yá´ğ”¥)ó°…‚ â¥‰ğ‘‘
seqs = pó°ˆ²ó°²¡xâ‚€áµ—â‰¡"seq_head"ó°…‚ êŸ¿ó°²£(Node("concat",xá¶œ), y)
red = ó°²£y.append(x) Â¿xá¹ğ”¥âˆ§(xâ‰”x.x)á¹á”Â¡ xá´ó°²¡red(x,y)ó°…‚
î¬¦ we assume no dups
seqs = seqs êŸ¿ó°²£yÎ¶(gen_ruleâˆ˜x á´ó°²¡red(x,yâ‰”[])â–ºy)ó°…‚ Î£ â¥‰ğ‘‘
new = symmap êŸ¿á´° ó°²£(x,â€¹<âŸ¦yâŸ§>â€º)ó°…‚
seqs.itemsî®¦ êŸ¿râ‰”ó°²£newâ‚“â‰”yá´â¥Œzâ†¦newî ” Â¿zâˆˆnewÂ¡ newî ”â‰”r(z,seqsî ”)ó°…‚Î£á¦
res = newâˆ©seqs á´ó°²¡â€¹âŸ¦newâ‚“âŸ§:"âŸ¦xâŸ§"ğ—»â€ºó°…‚ Î£âŸ¤

â˜¾res