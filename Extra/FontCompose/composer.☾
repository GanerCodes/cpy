ğ”¦ğ”ªğ”­â†â›s
â¨¡ string as ğ’
â®Œ peggle â¨¡ Parser, Node

symmap = {
        â›(: "parenleft"  , â›): "parenright"  ,
        â›{: "braceleft"  , â›}: "braceright"  ,
        â›[: "bracketleft", â›]: "bracketright",
        â›<: "less"       , â›>: "greater"     ,
        â›+: "plus"       , â›-: "minus"       ,
        â›/: "slash"      , â›\: "backslash"   ,
        â›!: "exclam"     , â›?: "question"    ,
        â›.: "period"     , â›,: "comma"       ,
        â›:: "colon"      , â›;: "semicolon"   ,
        â›&: "ampersand"  , â›%: "percent"     ,
        â›=: "equal"      , â›*: "asterisk"    ,
        â›_: "underscore" , â›|: "bar"         ,
        â›^: "asciicircum", â›~: "asciitilde"  ,
        â›#: "numbersign" , â›$: "dollar"      ,
        â›': "apostrophe" , â›": "quotedbl"    ,
        â›ğ•Š: "space"      , â›á´: "Multi_key"   ,
        â› : "space"      ,
        â ¶ğ‘‘(ğ’.ascii_letters+ğ’.digits á´ó°²¡xâ‹„êœ ) }
xcompose_from_seqs = ó°²¡x.itemsî®¦ êŸ¿ó°²£â€¹<Multi_key>âŸ¦yâŸ§:"âŸ¦xâŸ§"ğ—»â€ºó°…‚ Î£
âŠ¢ generate_compose(out=á—œ, pcomp="compose.âœâš™"  â¥‰ğ©,
                          pgram="compose.gram"â¥‰ğ©, no_write=â´´):
    â¨³ no_writeâˆ¨outâ‰‡á—œ
    Î© ğ”¥:
        __init__ = ó°²£x.xâ‰”â†y.xÂ¿yá¹ğ”¥Â¡yâ†’â–ºâ–¡
        __iter__ = ó°²¡xâ›¶â¥‰iter
    âŠ¢ gen_rule(n):
        Â¿náµ—â‰¡"letter": â†ªn.txt â¥‰ ğ”¥
        Â¿náµ—â‰¡"macref": â†ªmacs[n.txt]
        Â¿náµ—â‰¡"concat": â†ªná¶œ á´gen_rule â†’â¨‰â†’ á´ğ”¥
        Â¿náµ—â‰¡"looper": â†ªná¶œ á´gen_rule Å¿ó°ºó°» ó°²£x+(yâ›¶Â¿yá¹ğ”¥Â¡y)
    p = pgramâ‹„pcompá´ó°²¡x.openî®¦.readî®¦ó°…‚ Å¿á´¾áµƒÊ³Ë¢áµ‰Ê³ âˆ˜ â›
          á´ó°²¡yâ‰”xá¶œâ†’â‚€â‹„(yâ‚á¶œá´ó°²¡x Â¿xá¹á”Â¡ x.txt)
    macs = pó°ˆ²ó°²¡xâ‚€áµ—â‰¡"mac_head"ó°…‚ êŸ¿ó°²£(x.txt, yá´ğ”¥)ó°…‚ â¥‰ğ‘‘
    seqs = pó°ˆ²ó°²¡xâ‚€áµ—â‰¡"seq_head"ó°…‚ êŸ¿ó°²£(Node("concat",xá¶œ), y)
    red = ó°²£y.append(x) Â¿xá¹ğ”¥âˆ§(xâ‰”x.x)á¹á”Â¡ xá´ó°²¡red(x,y)ó°…‚
    î¬¦ we assume no dups
    seqs = seqs êŸ¿ó°²£yÎ¶(gen_ruleâˆ˜x á´ó°²¡red(x,yâ‰”[])â–ºy)ó°…‚ Î£ â¥‰ğ‘‘
    new = (og â‰” symmap êŸ¿á´° ó°²£(x,â€¹<âŸ¦yâŸ§>â€º)ó°…‚) | {}
    seqs.itemsî®¦ êŸ¿râ‰”ó°²£newâ‚“â‰”yá´â¥Œzâ†¦(og Â¿zâˆˆogÂ¡ new)î ” Â¿zâˆˆnewÂ¡ newî ”â‰”r(z,seqsî ”)ó°…‚Î£á¦
    
    âˆ€z,k in new.itemsî®¦: â˜¾(z,k)
    
    seqs = newâˆ©seqs á´ ó°²¡(x,newâ‚“)ó°…‚ â¥‰ ğ‘‘
    Â¿Â¬no_write: outâ¥‰ğ©â†’.open(â›w).write(xcompose_from_seqs âˆ˜ seqs)
    â†ªseqs

Â¿ __name__â‰¡"__main__": generate_compose(no_write=â´³) â˜¾