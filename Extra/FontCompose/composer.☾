ğ”¦ğ”ªğ”­â†â›s
â¨¡ string as ğ’
â®Œ peggle â¨¡ Parser, Node

symmap = {
        â›(: "parenleft"  , â›): "parenright"  ,
        â›{: "braceleft"  , â›}: "braceright"  ,
        â›[: "bracketleft", â›]: "bracketright",
        â›<: "less"       , â›>: "greater"     ,
        â›+: "plus"       , â›-: "minus"       ,
        â›/: "slash"      , â›\: "backslash"   ,
        â›!: "exclam"     , â›?: "question"    ,
        â›.: "period"     , â›,: "comma"       ,
        â›:: "colon"      , â›;: "semicolon"   ,
        â›&: "ampersand"  , â›%: "percent"     ,
        â›=: "equal"      , â›*: "asterisk"    ,
        â›_: "underscore" , â›|: "bar"         ,
        â›^: "asciicircum", â›~: "asciitilde"  ,
        â›#: "numbersign" , â›$: "dollar"      ,
        â›': "apostrophe" , â›": "quotedbl"    ,
        â›ğ•Š: "space"      , â›á´: "Multi_key"   ,
        â ¶ğ‘‘(ğ’.ascii_letters+ğ’.digits á´ó°²¡xâ‹„êœ ) }
xcompose_from_seqs = ó°²¡x.itemsî®¦êŸ¿ó°²£yâ‰”â†yÂ¿yá¹ğ‘¡Â¡yâ›¶áµ€â†’â–ºâ€¹âŸ¦â›á´+xá´ó°²¡â€¹<âŸ¦symmapâ‚“âŸ§>â€ºó°…‚Î£âŸ§:"âŸ¦yâ‚€âŸ§" # âŸ¦ğ˜€.joinâ†yâ‚€á´hexâ—‹ordâŸ§âŸ¦â€¹ ; âŸ¦yâ‚âŸ§â€ºÂ¿yğŸƒŒ>1Â¡á¦âŸ§ğ—»â€ºó°…‚ ó°’¼ó°²¡xğŸƒŒâ‹„xó°…‚ Î£
âŠ¢ generate_compose(out=á—œ, pcomp="compose.âœâš™"  â¥‰ğ©,
                          pgram="compose.gram"â¥‰ğ©, no_write=â´´):
    â¨³ no_writeâˆ¨outâ‰‡á—œ
    Î© ğ”¥:
        __init__ = ó°²£x.xâ‰”â†y.xÂ¿yá¹ğ”¥Â¡yâ†’â–ºâ–¡
        __iter__ = ó°²¡xâ›¶â¥‰iter
    âŠ¢ gen_rule(n):
        Â¿náµ—â‰¡"letter": â†ªn.txt â¥‰ ğ”¥
        Â¿náµ—â‰¡"macref": â†ªmacs[n.txt]
        Â¿náµ—â‰¡"concat": â†ªná¶œ á´gen_rule â†’â¨‰â†’ á´ğ”¥
        Â¿náµ—â‰¡"looper": â†ªná¶œ á´gen_rule Å¿ó°ºó°» ó°²£x+(yâ›¶Â¿yá¹ğ”¥Â¡y)
    p = pgramâ‹„pcompá´ó°²¡x.openî®¦.readî®¦ó°…‚ Å¿á´¾áµƒÊ³Ë¢áµ‰Ê³ âˆ˜ â›
          á´ó°²¡yâ‰”xá¶œâ†’â‚€â‹„(yâ‚á¶œá´ó°²¡x Â¿xá¹á”Â¡ x.txt)
    macs = pó°ˆ²ó°²¡xâ‚€áµ—â‰¡"mac_head"ó°…‚ êŸ¿ó°²£(x.txt, yá´ğ”¥)ó°…‚ â¥‰ğ‘‘
    seqs = pó°ˆ²ó°²¡xâ‚€áµ—â‰¡"seq_head"ó°…‚ êŸ¿ó°²£(Node("concat",xá¶œ), y)
    red = ó°²£y.append(x) Â¿xá¹ğ”¥âˆ§(xâ‰”xË£)á¹á”Â¡ xá´ó°²¡red(x,y)ó°…‚
    seqs = (seqs êŸ¿ó°²£yÎ¶(gen_ruleâˆ˜x á´ó°²¡red(x,yâ‰”[])â–ºyó°ˆ³ó°²¡xâ‰¡â›á¦)ó°…‚ Î£)á´á´™
    seqsord = ğ‘‘.fromkeys(seqsêŸ¿ó°²£yâ¥‰ğ‘¡ó°…‚)â¥‰ğ‘™
    nseqs, S = [], {}
    â° seqs:
        Î” = 0
        âˆ€o âˆˆ (xâ‰”seqs.popâˆ˜0)â‚€ğŸƒŒâ­¥:
            o, y = o + Î”, xâ‚€ ó°‚¼
            Â¿yá¹ğ‘–: â†º
            Â¿yâˆˆsymmap:
                xâ‚€ ó°‚¼ = ordâˆ˜y
            â¸˜yâˆˆS:
                xâ‚€ ó°‚¼ï¹•ó°‚¼â‚Šâ‚ = Sî “
                Î” += Sî “ğŸƒŒ-1
            Â¡:
                seqs += xâ›¶
                â‡¥
        Â¡:
            nseqs += xâ›¶
            S[xâ‚] = xâ‚€
    nseqs = nseqs êŸ¿ ó°²£(xá´chrÎ£, y)ó°…‚ â›
                  ó°’¼ ó°²¡seqsord.index(xâ‚â¥‰ğ‘¡)ó°…‚ â¥‰ ğ‘‘
    
    Â¿Â¬no_write: outâ¥‰ğ©â†’.open(â›w).write(xcompose_from_seqs âˆ˜ nseqs ó°’¼)
    â†ªnseqs

Â¿ __name__â‰¡"__main__": xcompose_from_seqs(generate_compose(no_write=â´³)) â˜¾