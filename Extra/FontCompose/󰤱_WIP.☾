â®Œ peggle â¨¡ Parser
ğŸŒˆ = ó°‹º("ğŸŒˆ")

GRAM = â›
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
main = ó°†´Î©? (rule ó°†´Î©?)*

rule = rule_macro âˆ¨ â ¶rule_not_macro
rule_macro = Â¡ (word) ó°†´W? â— (â ¶(âŸ¶ output_chars âˆ¨ rule_not_macro âˆ¨ body_recurse))

rule_not_macro = R_S_C âˆ¨ R_S_0 âˆ¨ R_C_S âˆ¨ R_C âˆ¨ R_S_1
R_S_C = ( â ¶style_hbra compose_head) (body_recurse âˆ¨ â ¶compose_body_options)
R_S_0 = (  style_head             ) (body_recurse âˆ¨ (sty output_chars))
R_C_S = (compose_head  â ¶style_hbra) (body_recurse âˆ¨ â ¶compose_body_options)
R_C   = (compose_head             ) (body_recurse âˆ¨ â ¶compose_body_options)
R_S_1 = ( â ¶style_hbra             ) (body_recurse âˆ¨ ((sty? âœ“) (âŸ¶? âœ“) output_chars))
compose_body_options = ((âŸ¶? âœ“) output_chars)
body_recurse = â¦‘ â ¶main â¦’

style_hbra = â¦‘ style_head â¦’ ó°†´w?
style_head = â ¶tuple
tuple = ((| (| âœ“)*)? chain)+
pair  = Æ¨(word) ó°†´W? â¦‘ â ¶tuple? â¦’
chain = (pair âˆ¨ word)+ ó°†´W?

macref = âŸ¨ (Â¡ â¯† word) âŸ©

output_chars = ( âŸ¦ (â ¶output_chars âˆ¨ ó°†´Î©)* âŸ§
                 âˆ¨ ((str âˆ¨ ~â€¹[^"âŸ¦âŸ§\t\n ]â€º) ó°†´w?)+ )+
compose_head = â ¶(
    ( (looper = âŸ¦ â ¶compose_head âŸ§)
    âˆ¨ (concat = â… â ¶compose_head â†)
    âˆ¨ macref âˆ¨ lookup) ó°†´W?)+ ó°†´W?
lookup = Æ¨(str âˆ¨ chr âˆ¨ '|')
word   = Æ¨(str âˆ¨ chr+)
str    = Æ¨(esc âˆ¨ (ó°†´'"' ((esc âˆ¨ ~â€¹[^"]â€º)*) ó°†´'"'))
sty    = ó°†´w? â†· ~â€¹[ğ”â„œ]â€º
esc    = ó°†´â€¹â›â›â€º ~â€¹.?â€º

bad = ~â€¹[ğ”â„œâŸ¨âŸ©âŸ¦âŸ§â…â†â¦‘â¦’"|â âŸ¶\t\n ]â€º
chr = (Â¬bad) ~â€¹.â€º

(âŸ¦=ó°†´(W?â†·'âŸ¦'))(âŸ§=ó°†´(W?â†·'âŸ§'))(â…=ó°†´(W?â†·'â…'))(â†=ó°†´(W?â†·'â†'))
(â¦‘=ó°†´(W?â†·'â¦‘'))(â¦’=ó°†´(W?â†·'â¦’'))(âŸ¨=ó°†´(W?â†·'âŸ¨'))(âŸ©=ó°†´(W?â†·'âŸ©'))
(Â¡=ó°†´(W?â†·'Â¡'))(|=ó°†´(W?â†·'|'))(âŸ¶=ó°†´(W?â†·'âŸ¶'))

w = ~â€¹[ \t]+â€º
W = ~â€¹[ \t\n]+â€º
Î© = ~â€¹[ \t\nâ ]+â€º
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥

dat = â›
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
a|bc â¦‘câ¦‘Aâ¦’|uâ¦’ âŸ¶ â—RCS
Â¡ alp âŸ¶ ABC
Â¡ num â¦‘
  abc â¦‘câ¦‘1â¦’â¦’ âŸ¶ â—RSC2
â¦’

â¦‘câ¦‘Aâ¦’â¦’ abc âŸ¶ â—RSC
abc        âŸ¶ â—RC
â¦‘câ¦‘Aâ¦’â¦’     âŸ¶ â—RS1_ex1
â¦‘câ¦‘Aâ¦’â¦’  â„œ  âŸ¶ â—RS1_ex2
 câ¦‘|Aâ¦’Bâ¦‘s|0â¦’ â„œ    RS0 â›â›â›""abccc" âŸ¦
         asdaaa
         asd asd asd â›j
âŸ§
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥

î¬¦ dat = ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥abc â¦‘câ¦‘af|2||aâ¦’u|câ¦‘ffâ¦’uâ¦’ âŸ¶ â—RSC2ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥

î¬¦ aâŸ¦bâŸ§âŸ¨alpâŸ© â¦‘câ¦‘f00â¦’â¦’ WEE
î¬¦ câ¦‘f00â¦’ â„œ aosidjiao

Î© ğ:
    âŠ¢ __init__(ğ•Š, t, â ¤c): ğ•Š.t, ğ•Š.c = t, c
    __iter__ = ğ•Šâ†¦iter(ğ•Š.c)
    __repr__ = ğ•Šâ†¦â€¹âŸ¦ğ•Šáµ—âˆ¨â›âˆ…âŸ§âŸ¨âŸ¦", ".join(ğ•Šá´á”)âŸ§âŸ©â€º
    tt = ğ•Šâ†¦(ğ•Šáµ—,ğ•Šá¶œá´ó°²¡xáµ—áµ—î®¦Â¿xá¹ğÂ¡x)
    ft = ğ’®â„³â†ó°²¡ğ(xâ‚€,â ¤xâ‚á´ğá¶ áµ—Â¿xâ‚á¹ğ‘™|ğ‘¡âˆ§xâ‚ğŸƒŒâ‰¡2Â¡xâ‚â›¶)
    copy  = â¥Œğ•Š,t=â–¡,c=â–¡â†¦ğ(ğ•Šáµ—Â¿tâ‰…â–¡Â¡t, â ¤ğ•Šá¶œÂ¿câ‰…â–¡Â¡c)
    rcopy = â¥Œğ•Š,t=â–¡â†¦ğ(ğ•Šáµ—Â¿tâ‰…â–¡Â¡t, â ¤ğ•Šá¶œá´ğ.rcopy)Â¿ğ•Šá¹ğÂ¡ğ•Š
    âŠ¢ frp(ğ•Š, f, r):
        Â¿Â¬â†ğ•Šá¹ğ: â†ªğ•Š
        Â¿f(ğ•Š): â†ªr(ğ•Š)
        â†ª ğ•Š.copy(c=ğ•Šá´ó°²¡ğ.frp(x,f,r))
    âŠ¢ extract(ğ•Š, f, E=â–¡, Î²=âœ“):
        Â¿Â¬â†ğ•Šá¹ğ: â†ªğ•Š
        L = r, E = [[], []Â¿(Ïâ‰”Eâ‰…â–¡)Â¡E]
        ğ•Šá´ó°²¡L[xá¹ğ âˆ§ (ğ‘â†fâ†x)].append(x)
        n = ğ•Š.copy(c=rá´ó°²¡ğ.extract(x,f,E))
        â†ª E Â¿Ïâˆ§Î²Â¡ n
    filter = â¥Œğ•Š,fâ†¦ğ•Š.extract(Â¬â—‹ğ‘â—‹f,â ¤ğ”¸,â ¶ğ•‚,Î²=âœ—)



fargs = Æ’â†¦Æ’.__code__.co_varnames[:Æ’.__code__.co_argcount]
gen, gens = nâ†¦Æ’â†¦gensâ‚™â‰”Æ’, {}
gen(â›c)â†â¥Œx=â–¡,y=â–¡,z=â–¡â†¦{ â ¶xâˆ§{          "color": ğŸŒˆ.h2hlâ†x}âˆ¨{},
                       â ¶yâˆ§{"backgroundColor": ğŸŒˆ.h2hlâ†y}âˆ¨{},
                       â ¶zâˆ§{    "borderColor": ğŸŒˆ.h2hlâ†z}âˆ¨{} }
gen(â›B)â†â¥Œx,y=1,r=1â†¦â„µ(borderStyle  = â€¹sâ€‰solidâŸdâ€‰dashedâ€ºâ­â¥‰ğ‘‘â†’â‚“,
                     borderWidth  = â€¹âŸ¦yâŸ§pxâ€º,
                     borderRadius = â€¹âŸ¦râŸ§pxâ€º)
gen(â›b)â†ğš²â„µ(fontStyle="bold")
gen(â›u)â†â¥Œx=1â†¦â„µ(textDecoration=â€¹underline âŸ¦xâŸ§pxâ€º)
âŠ¢ decor(n):
    R = []
    âˆ€nâˆˆn:
        r = {}
        âˆ€t,vâˆˆnâ‚:
            Â¿t â‰¡ "word":
                r |= gens[v]î®¦
            â¸˜t â‰¡ "pair":
                t, v = v
                v = vâ‚
                É™ = v êŸ¿ó°²£â–¡ Â¿xâ‰¡â›âœ“Â¡ ğ˜€.join(yêŸ¿ó°²£y)
                Æ’ = gensâ‚œ
                r |= Æ’(â ¶{k:vâˆ€k,vâˆˆfargs(Æ’)Î¶É™Â¿kâ‰‡â–¡})
        R += râ›¶
    â†ª R

âŠ¢ RCR(Î¹, f, r):
    Â¿Î¹á¹ğ‘¡â†’Â¬: â†ªÎ¹
    Î½ = Î¹â†¦(Î¹â‚€, Î¹â‚ á´ó°²¡RCR(x,f,r) Â¿xá¹ğ‘™Â¡ x)
    â†ª râˆ˜Î¹ Â¿fâˆ˜Î¹Â¡ Î½âˆ˜Î¹

âŠ¢ parse(dat, gram=Parser(GRAM)):
    dat = ğ—».joinâ†dat.split(ğ—»)ó°ˆ³ó°²¡x.lstrip().startswithâ†â›î¬¦ó°…‚
    root = gram(dat, DEBUG=âœ—)
    root = root.child_killer(ó°²¡xáµ—âˆˆğ‘ â†â€¹â„œÂ¡|â›âŸ¦â›âŸ§â…â†â¦‘â¦’âŸ¨âŸ©âŸ¶â€º)
    root = root.find_replace(ó°²¡âœ“, ó°²¡xáµ—âˆ§(xáµ—,xá¶œ)âˆ¨xá¶œ)
    root = ğ.ft(root)
    î¬¦ â®Œ pprint â¨¡ pp
    î¬¦ pp(root.ttî®¦)
    î¬¦ exitî®¦
    root = root.frp(ó°²¡xáµ—â‰¡"style_head", ó°²¡x.copy(c=decor(xá¶œ)))
    â†ª root

parseâˆ˜dat â†’ â˜¾
î¬¦ parseâˆ˜dat â†’ â˜¾

î¬¦ n = ğ.ft(("a", [
î¬¦         ("b", "hello"),
î¬¦         ("c", "asdas"),
î¬¦         ("d", [
î¬¦             ("", 1),
î¬¦             ("k", "joe")
î¬¦         ])
î¬¦     ])).ttî®¦â˜¾
î¬¦ n.extract(ó°²¡xáµ—âˆˆ"k")â˜¾


ğŸŸ‘
ó°¤±: extract out style regex exprs
ó°¤±: invent the not-bad Node
ó°¤±: better macros
ó°¤±: make R_S/_?/C's same format
    â„µ(style={}, seq=á¦, data=[])
ó°¤±: finish ó°¤±
ğŸŸ‘