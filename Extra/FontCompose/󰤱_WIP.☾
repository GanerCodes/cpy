GRAM = â›
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
main = ó°†´Î©? â–³ â ¶rule

rule = rule_macro âˆ¨ â ¶rule_not_macro
rule_macro = Â¡ word ó°†´W? â ¶(âŸ¶ compose_body âˆ¨ rule_not_macro)

rule_not_macro = R_S_C âˆ¨ R_S_0 âˆ¨ R_C_S âˆ¨ R_C âˆ¨ R_S_1
R_S_C = (â ¶  style_hbra  compose_head) (body_recurse âˆ¨ â ¶compose_body_options)
R_S_0 = (   style_head              ) (body_recurse âˆ¨ (sty compose_body))
R_C_S = ( compose_head   â ¶style_hbra) (body_recurse âˆ¨ â ¶compose_body_options)
R_C   = ( compose_head              ) (body_recurse âˆ¨ â ¶compose_body_options)
R_S_1 = (â ¶  style_hbra              ) (body_recurse âˆ¨ (sty? compose_body))
compose_body_options = (âŸ¶ compose_body) âˆ¨ compose_body
body_recurse = â¦‘ â ¶main â¦’

style_hbra = â¦‘ â ¶style_head â¦’ ó°†´w?
style_head = â ¶tuple
tuple = chain âˆ¨ (| (| âœ“)*)
pair  = Æ¨(word) ó°†´W? â¦‘ â ¶tuple? â¦’
chain = (pair âˆ¨ word)+ ó°†´W?

macref = âŸ¨ (Â¡ â¯† word) âŸ©

compose_body = ( âŸ¦ (compose_body âˆ¨ ó°†´Î©)* âŸ§
                 âˆ¨ ((str âˆ¨ Â¬(~â€¹âŸ¦âŸ§\t\n â€º) ~â€¹.â€º) ó°†´w?)+ )
compose_head = â ¶(
    ( (looper = âŸ¦ â ¶compose_head âŸ§)
    âˆ¨ (concat = â… â ¶compose_head â†)
    âˆ¨ macref âˆ¨ lookup) ó°†´W?)+ ó°†´W?
lookup = Æ¨(str âˆ¨ chr)
word   = Æ¨(str âˆ¨ chr+)
str    = Æ¨(esc âˆ¨ ('"' (esc âˆ¨ ~â€¹[^"].â€º)* '"'))
sty    = ó°†´w? â†· ~â€¹[ğ”â„œ]â€º
esc    = ó°†´â€¹â›â›â€º ~â€¹.?â€º

bad = ~â€¹[^ğ”â„œâŸ¨âŸ©âŸ¦âŸ§â…â†â¦‘â¦’"â âŸ¶\t\n ]â€º
chr = Â¬bad ~â€¹.â€º

(âŸ¦=ó°†´(W?â†·'âŸ¦'))(âŸ§=ó°†´(W?â†·'âŸ§'))(â…=ó°†´(W?â†·'â…'))(â†=ó°†´(W?â†·'â†'))
(â¦‘=ó°†´(W?â†·'â¦‘'))(â¦’=ó°†´(W?â†·'â¦’'))(âŸ¨=ó°†´(W?â†·'âŸ¨'))(âŸ©=ó°†´(W?â†·'âŸ©'))
(Â¡=ó°†´(W?â†·'Â¡'))(|=ó°†´(W?â†·'|'))(âŸ¶=ó°†´(W?â†·'âŸ¶'))

w = ~â€¹[ \t]+â€º
W = ~â€¹[ \t\n]+â€º
Î© = ~â€¹[ \t\nâ ]+â€º
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥

dat = â›
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
Â¡ alp âŸ¶ ABC
Â¡ num â¦‘
  abc â¦‘câ¦‘Aâ¦’â¦’ âŸ¶ â—RSC2
â¦’
â¦‘câ¦‘Aâ¦’â¦’ abc âŸ¶ â—RSC
abc â¦‘câ¦‘Aâ¦’â¦’ âŸ¶ â—RCS
abc        âŸ¶ â—RC
â¦‘câ¦‘Aâ¦’â¦’     âŸ¶ â—RS1_ex1
â¦‘câ¦‘Aâ¦’â¦’  â„œ  âŸ¶ â—RS1_ex2
 câ¦‘Aâ¦’   â„œ    â—RS0
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
î¬¦ aâŸ¦bâŸ§âŸ¨alpâŸ© â¦‘câ¦‘f00â¦’â¦’ WEE
î¬¦ câ¦‘f00â¦’ â„œ aosidjiao

â®Œ peggle â¨¡ Parser
ó°‹º(â€¹ó°¤±_WIP_COLORSâ€º, â€¹decorâ€º)

âŠ¢ parse(dat, gram=Parser(GRAM)):
    dat = ğ—».joinâ†dat.split(ğ—»)ó°ˆ³ó°²¡x.lstrip().startswithâ†â›î¬¦ó°…‚
    root = gramâˆ˜dat
    root = root.child_killer(ó°²¡xáµ—âˆˆğ‘ â†â€¹â„œÂ¡|â›âŸ¦â›âŸ§â…â†â¦‘â¦’âŸ¨âŸ©âŸ¶â€º)
    î¬¦ root = root.find_replace(
    î¬¦   ó°²¡xáµ— == "style_head",
    î¬¦   ó°²¡decor(x))
    â†ª root

parseâˆ˜dat â†’ .printî®¦