#!/bin/bash
# ⌘ℿ〚〛⟨⟩⩇𝟶≬𝄞⋿⦁⦂⦇⦈⦉⦊⨾⩤⩥⨝϶⛶⛯
# ᐜᐝᐞᐟᐠᐡᐢᐣᐤᐥᐨᐩᐪ
# ⠤⠶⨯⌃⟳➰⥀⮂❟∘𐞁ʽ¨←→𝚲ƛ𝝺𝕋𝔽𝔸𝕂ℂ𝕊⤉⤈⋀⋁Σ☾🃌⨳ᴍ⚇ζ↕↨🜌⍟⇧⇳πτî∅□ᐦ∧∨∈∉¬λ⁅⁆⮌⨡¿¡⸘∀🢖≔≤≥≡≠¯⋄⥌↦⑴⑵⑶↪⊢»↺⇥≟⎊…≾⩫ₓᵧ¹²
# ₀₁₂₃₄₅₆₇₈₉﹕˲﹐₋₊

# ADD reduce

CPYTH="$(readlink -m "$0/..")"

set -e
for file in $(find . -name '*.cpy'); do
    base_name="${file%.cpy}"
    new_name="${base_name}.py"
    
       (cat "$CPYTH/header.cpy" && echo '' \
     && cat "$CPYTH/combinators.cpy" && echo '' \
     && cat "$file") | tr '\n' '\f' | sed -E \
        -e's/(֎[^֎]*֎)|(🟑[^🟑]*🟑)//g' | tr '\f' '\n' \
     | python "$CPYTH/compile.py" | sed -E \
        -e's/‹/f"""/g' -e's/›/""" /g' \
        -e's/[⠤⨯]/*/g' -e's/[⠶⌃]/**/g' -e's/[𝚲ƛ𝝺]/<$$>/g' \
        -e's/[⟳➰]/while /g' -e's/[⥀⮂]/yield /g' -e's/(.)❟/\"\1"/g' \
		-e's/[₀₁₂₃₄₅₆₇₈₉﹕˲﹐₋₊]{1,}/[\0]/g' \
        -e'y/₀₁₂₃₄₅₆₇₈₉﹕˲﹐₋₊/0123456789::,-+/' \
        -e's/∘/ⶦOP_COMPOSE_ⶦ/g' -e's/ⶦⶦ/ⶦ/g' \
        -e's/¹/**OP_TO_UNARY_/g' -e's/²/**OP_TO_BNARY_/g' \
        -e's/𐞁/ⶾOP_SWAP_ⶦ/g' -e's/ʽ/ⶾOP_DUP_/g' -e's/¨/ⶾOP_METAMAP_/g' \
        -e's/ⶦⶾ/ⶾ/g' -e's/([ⶦⶾ]*)→/\>\>/g' \
        -e's/←([ⶦⶾ]*)/\<\</g' -e's/ⶦ/+/g' \
        -e's/ⶾ/@/g' > "$new_name"
    echo "${file} → ${new_name}"

done
echo "Compiled."
[ $# -eq 0 ] || "$CPYTH/bin/cpy_binary" "$@"