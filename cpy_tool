#!/bin/bash
# âŒ˜â„¿ã€šã€›âŸ¨âŸ©â©‡âŒ¢âŒ£âœâğŸ¶â‰¬ğ„â‹¿â¦â¦‚â¦‡â¦ˆâ¦‰â¦Šâ¨¾â©¤â©¥â¨Ï¶â›¶â›¯
# áœáááŸá á¡á¢á£á¤á¥á¨á©áª
# â ¤â ¶â¨¯âŒƒâŸ³â°â¥€â®‚âŸâˆ˜ğÊ½Â¨â†â†’ğš²Æ›ğºğ•‹ğ”½ğ”¸ğ•‚â„‚ğ•Šâ¤‰â¤ˆâ‹€â‹Î£â˜¾ğŸƒŒâ¨³á´âš‡Î¶â†•â†¨ğŸœŒâŸâ‡§â‡³Ï€Ï„Ã®âˆ…â–¡á¦âˆ§âˆ¨âˆˆâˆ‰Â¬Î»â…â†â®Œâ¨¡Â¿Â¡â¸˜âˆ€ğŸ¢–â‰”â‰¤â‰¥â‰¡â‰ Â¯â‹„â¥Œâ†¦â‘´â‘µâ‘¶â†ªâŠ¢Â»â†ºâ‡¥â‰ŸâŠâ€¦â‰¾â©«â‚“áµ§Â¹Â²
# â‚€â‚â‚‚â‚ƒâ‚„â‚…â‚†â‚‡â‚ˆâ‚‰ï¹•Ë²ï¹â‚‹â‚Š

# ADD reduce

CPYTH="$(readlink -m "$0/..")"

set -e
for file in $(find . -name '*.cpy'); do
    base_name="${file%.cpy}"
    new_name="${base_name}.py"
    
       (cat "$CPYTH/header.cpy" && echo '' \
     && cat "$CPYTH/combinators.cpy" && echo '' \
     && cat "$file") | tr '\n' '\f' | sed -E \
        -e's/(Ö[^Ö]*Ö)|(ğŸŸ‘[^ğŸŸ‘]*ğŸŸ‘)//g' | tr '\f' '\n' \
     | python "$CPYTH/compile.py" | sed -E \
        -e's/â€¹/f"""/g' -e's/â€º/""" /g' \
        -e's/[â ¤â¨¯]/*/g' -e's/[â ¶âŒƒ]/**/g' -e's/[ğš²Æ›ğº]/<$$>/g' \
        -e's/[âŸ³â°]/while /g' -e's/[â¥€â®‚]/yield /g' -e's/(.)âŸ/\"\1"/g' \
		-e's/[â‚€â‚â‚‚â‚ƒâ‚„â‚…â‚†â‚‡â‚ˆâ‚‰ï¹•Ë²ï¹â‚‹â‚Š]{1,}/[\0]/g' \
        -e'y/â‚€â‚â‚‚â‚ƒâ‚„â‚…â‚†â‚‡â‚ˆâ‚‰ï¹•Ë²ï¹â‚‹â‚Š/0123456789::,-+/' \
        -e's/âˆ˜/â¶¦OP_COMPOSE_â¶¦/g' -e's/â¶¦â¶¦/â¶¦/g' \
        -e's/Â¹/**OP_TO_UNARY_/g' -e's/Â²/**OP_TO_BNARY_/g' \
        -e's/ğ/â¶¾OP_SWAP_â¶¦/g' -e's/Ê½/â¶¾OP_DUP_/g' -e's/Â¨/â¶¾OP_METAMAP_/g' \
        -e's/â¶¦â¶¾/â¶¾/g' -e's/([â¶¦â¶¾]*)â†’/\>\>/g' \
        -e's/â†([â¶¦â¶¾]*)/\<\</g' -e's/â¶¦/+/g' \
        -e's/â¶¾/@/g' > "$new_name"
    echo "${file} â†’ ${new_name}"

done
echo "Compiled."
[ $# -eq 0 ] || "$CPYTH/bin/cpy_binary" "$@"