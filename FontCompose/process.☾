ğ”¦ğ”ªğ”­âˆ˜â›s
â¨¡ string as ğ’
â®Œ tempfile â¨¡ NamedTemporaryFile as NTF
â®Œ json5 â¨¡ load as jl
â®Œ json â¨¡ dumps as jds
â®Œ peggle â¨¡ Parser
ğŸŒˆ = ó°‹ºâˆ˜â›ğŸŒˆ
ó°‹º(â›ğ, â›ğ)
ó°‹º("kots", *)
ó°‹º("multisupersubscriptify", â ¤â€¹load_fontâ€‰save_fontâ€‰add_scriptâ€‰remove_charâ€‰add_multicharâ€ºâ­)
ó°‹º("organizer", â ¤â€¹get_codepointâ€‰save_puaâ€ºâ­)

jdumps = oâ†¦(o.__json__ Â¿hasattr(o, jdumps, "__json__")Â¡ jds)(â ¤ğ”¸, â ¶ğ•‚)

symmap = {
        â›(: "parenleft"  , â›): "parenright"  ,
        â›{: "braceleft"  , â›}: "braceright"  ,
        â›[: "bracketleft", â›]: "bracketright",
        â›<: "less"       , â›>: "greater"     ,
        â›+: "plus"       , â›-: "minus"       ,
        â›/: "slash"      , â›\: "backslash"   ,
        â›!: "exclam"     , â›?: "question"    ,
        â›@: "at"         ,
        â›.: "period"     , â›,: "comma"       ,
        â›:: "colon"      , â›;: "semicolon"   ,
        â›&: "ampersand"  , â›%: "percent"     ,
        â›=: "equal"      , â›*: "asterisk"    ,
        â›_: "underscore" , â›|: "bar"         ,
        â›^: "asciicircum", â›~: "asciitilde"  ,
        â›#: "numbersign" , â›$: "dollar"      ,
        â›': "apostrophe" , â›": "quotedbl"    ,
        â›ğ•Š: "space"      , â›á´: "Multi_key"   , â›â—Œ: â›â—Œ,
        â ¶ğ‘‘(ğ’.ascii_letters+ğ’.digits á´ó°²¡xâ‹„êœ ) }

fargs = Æ’â†¦Æ’.__code__.co_varnames[:Æ’.__code__.co_argcount]
âŠ¢ hsh(s):
        Â¿á¹(s, ğ‘‘): â†ª ğ‘¡((k,hsh(v))âˆ€k,vâˆˆs.itemsî®¦)
        Â¿á¹(s, ğ‘™): â†ª ğ‘¡(hsh(v) âˆ€vâˆˆs)
        â†ª s

gen, gens = nâ†¦Æ’â†¦gensâ‚™â‰”Æ’, {}
gen(â›c)â†â¥Œx=â–¡,y=â–¡,z=â–¡â†¦{ â ¶xâˆ§{          "color": ğŸŒˆ.h2hlâ†x}âˆ¨{},
                       â ¶yâˆ§{"backgroundColor": ğŸŒˆ.h2hlâ†y}âˆ¨{},
                       â ¶zâˆ§{    "borderColor": ğŸŒˆ.h2hlâ†z}âˆ¨{} }
gen(â›B)â†â¥Œx,y=1,r=1â†¦â„µ(borderStyle  = â€¹sâ€‰solidâŸdâ€‰dashedâ€ºâ­â¥‰ğ‘‘â†’â‚“,
                     borderWidth  = â€¹âŸ¦yâŸ§pxâ€º,
                     borderRadius = â€¹âŸ¦râŸ§pxâ€º)
gen(â›b)â†ğš²â„µ(fontStyle="bold")
gen(â›N)â†ğš²â„µ(NO_SCALE=â´³)
gen(â›u)â†â¥Œx=1â†¦â„µ(textDecoration=â€¹underline âŸ¦xâŸ§pxâ€º)
âŠ¢ decor(n, multi=â´´):
    R = []
    âˆ€nâˆˆn:
        r = {}
        âˆ€nâˆˆn:
            t, v = náµ—, ná¶œ
            Â¿t â‰¡ "word":
                r |= gens[vâ‚€áµ—]î®¦
            â¸˜t â‰¡ "pair":
                t, c = vâ‚€áµ—, vâ‚á¶œ
                É™ = c á´ó°²¡â–¡ Â¿xáµ—â‰¡â›âœ“Â¡ ğ˜€.join(x.extract(ó°²¡Â¬xá¶œ,Î”=âœ—)á´ó°²¡xáµ—)
                Æ’ = gensâ‚œ
                r |= Æ’(â ¶{k:vâˆ€k,vâˆˆfargs(Æ’)Î¶É™Â¿kâ‰‡â–¡})
        R += râ›¶
    â†ª RÂ¿multiÂ¡Râ‚€

âŠ¢ supermcdoublerecursivecomposeoutputstyleparsemachine(
        n, pre=â–¡, mac=â–¡, res=â–¡):
    mac, pre, res = {}Â¿macâ‰…â–¡Â¡mac, []Â¿preâ‰…â–¡Â¡pre, []Â¿resâ‰…â–¡Â¡res
    ğ•¤ = ğš²supermcdoublerecursivecomposeoutputstyleparsemachine(â ¤ğ”¸,mac=mac,res=res)
    Â¿náµ—â‰¡"main":
        ğ•¤(n.copy(t="looper"),pre)
        â†ª mac, res
    Â¿náµ—â‰¡"looper": â†ª ná´ó°²¡ğ•¤(x,pre)ó°…‚Î£[]
    Â¿náµ—â‰¡"concat":
        seqs, L = [pre], ná´ó°²¡x
        â°L:
            N = L.popâˆ˜0
            nseqs = []
            âˆ€pâˆˆseqs:
                nseqs += ğ•¤(N, p) î¬¦ [seq]
            seqs = nseqs
        â†ª seqs
    Â¿náµ—â‰¡"style":  â†ª [[â ¤pre, ("STYLE", nâ‚€áµ—)]]
    Â¿náµ—â‰¡"lookup": â†ª [pre+(("LIT", nâ‚€ â‚€áµ—)Â¿nâ‚€áµ—â‰¡"str"Â¡nâ‚€áµ—)â›¶] î¬¦ ó°¤± strs (ó·¹‡ they special!)
    Â¿náµ—â‰¡"results":
        C, â ¤ná¶œ = n
        res.append((pre, (Câ‚€Â¿CğŸƒŒÂ¡C)áµ—))
        â†ª [pre]
    Â¿náµ—â‰¡"macadd":
        â ¤w, s = n
        seqs = ğ•¤(s, pre +â† wá´ó°²¡("TAG", xâ‚€áµ—))
        w á´ó°²¡mac.setdefault(xâ‚€áµ—,[]).extend(seqs)
        â†ª seqs
    Â¿náµ—â‰¡"macref":
        n = nâ‚€
        val = mac[nam â‰” nâ‚€ â‚€áµ— Öó°¤±ôŠ½¨Ö]
        Â¿náµ—â‰¡"macref_tag":
            â–¡ î¬¦pre += [("TAG", nam)]
        Â¡:
            val á´= ó°²¡x ó°ˆ³ó°²¡xá¹ğ‘¡âˆ§xâ‚€â‰¡"TAG"
        â†ª val á´ó°²¡pre+x

âŠ¢ normalize_seqs(d): î¬¦ comically slow lol
    ğ”” = d.itemsî®¦ êŸ¿â¥Œk,vâ†¦v.seqsá´ó°²¡(k,x)ó°…‚ó°…‚ Î£ []
    ğ”’ = []
    â° ğ””:
        (k, v) = ğ””.popâˆ˜0
        â„­ = v.copyî®¦
        ns = á¦
        â° â„­:
            É™ = â„­.popâˆ˜0
            Â¿É™á¹ğ‘¡â†’Â¬:
                Â¿É™â‰¡â›á¦:
                    â†º
                â¸˜É™âˆˆsymmap:
                    ns += É™
                    â†º
                Â¡:
                    ğ””.append((k, [(â›âœ“, ns), ("LIT", É™), â ¤â„­]))
                    â‡¥
            
            op, s = É™
            â¨³ opâˆˆâ€¹LITâ€‰âœ“â€ºâ­
            Â¿opâ‰¡â›âœ“:
                ns += s
                â†º
            Â¿Â¬vâ‰”ğ”’ó°ˆ²ó°²¡xâ‚€â‰¡só°…‚ â†’âˆ§ vğŸƒŒâ‰ dâ‚–.seqsğŸƒŒ:
                ğ””.append((k, [(â›âœ“, ns), É™, â ¤â„­]))
                â‡¥
            Â¿vğŸƒŒâ‰¡1:
                ns += vâ‚€ â‚
                â†º
            âˆ€hâˆˆv:
                ğ””.append((k, [(â›âœ“, ns + hâ‚), â ¤â„­]))
            â‡¥
        Â¡:
            î¬¦ Â¿kâ‰¡â›â—Œ: â†º î¬¦ make a quoted â—Œ work
            ğ”’.append((k, ns))
    ğ”’ î®†= ó°²¡xâ‚€
    ğ”’ = ğ”’êŸ¿â±½ó°²£ğ‘ (yá´ó°²¡xâ‚)
    â†ª d êŸ¿â±½ ó°²£y(seqs=ğ”’â‚“)

âŠ¢ collect_styles(d):
    stylez = {}
    âˆ€k,vâˆˆd.itemsî®¦:
        Â¿Â¬v.style: â†º
        stylez.setdefault(hsh(v.style), (v.style, []))â‚.append(k)
    â†ª stylez.valuesî®¦êŸ¿ó°²£(x.pop("NO_SCALE", â–¡)â–ºx,yÎ£á¦)

xcompose_from_seqs = ó°²¡x.itemsî®¦êŸ¿ó°²£yâ‰”â†yÂ¿yá¹ğ‘¡Â¡yâ›¶áµ€â†’â–ºâ€¹âŸ¦â›á´+xá´ó°²¡â€¹<âŸ¦symmapâ‚“âŸ§>â€ºó°…‚Î£âŸ§:"âŸ¦yâ‚€.replace(â ¤â€¹\â€‰\\â€ºâ­)âŸ§" # âŸ¦ğ˜€.joinâ†yâ‚€á´hexâ—‹ordâŸ§âŸ¦â€¹ ; âŸ¦yâ‚âŸ§â€ºÂ¿yğŸƒŒ>1Â¡á¦âŸ§ğ—»â€ºó°…‚ ó°’¼ó°²¡xğŸƒŒâ‹„xó°…‚ Î£

âŠ¢ edit_vs_settings(dat, p):
    p = ğ©âˆ˜pâ†’.expanduserî®¦.resolveî®¦
    shutil.copy(p, xâ‰”ğ©â†NTF(delete=â´´).name)
    â˜¾â€¹Backing up old settings to temp file: âŸ¦xâŸ§â€º,
    
    jargs = â„µ(ensure_ascii=âœ—, indent=â–¡, separators=",:")
    j = jl(p.openâ†"rb")
    
    nj = dat | j.get("â˜¾.highlight_extra", {})
    TXT = (p.openâ†"r"â†’.readî®¦)
    inj = â€¹ğ—»ğ˜/*DON'T REMOVE THE START/END COMMENTS IN THIS SECTION THIS IS HOW WE FIGURE OUT WHERE EVERYTHING IS*/ğ—»ğ˜"highlight.regexes": âŸ¦jds(nj, â ¶jargs)âŸ§â€º
    S, E = "BEGâ€‰PLEAD"â­á´ó°²¡â€¹/*ó°¦¥ó°¦¥ó°¦¥âŸ¦xâŸ§ó°¦¥ó°¦¥ó°¦¥*/â€º
    (qâ‰”Sâ‹„Eá´ó°²¡xâˆˆTXTó°…‚Î£â†’âˆˆ0â‹„2) â¨³ "Malformed indicators!"
    TXT = TXTï¹•â‚‹â‚.rstripî®¦.rstripâˆ˜â›, + TXTâ‚‹â‚
    Â¿Â¬q:
        "Creating indicators!"â˜¾
        Â¿Â¬(TXTâ‰”TXT.rstripî®¦).lstripî®¦: TXT = â›{â‹„â›}
        TXTâ‚‹â‚â‰¡â›} â¨³ "Please don't end your settings with a comment!"
        txt=TXTâ¥‰ğ‘™
        txtâ‚‹â‚ï¹• = â€¹,ğ—»ğ˜âŸ¦SâŸ§âŸ¦injâŸ§âŸ¦EâŸ§ğ—»}â€º
    Â¡:
        txt=TXTâ¥‰ğ‘™
        txt[TXT.indexâˆ˜S+SğŸƒŒ:ei] = inj+â›,â‹…((eiâ‰”TXT.indexâˆ˜E)+EğŸƒŒ<TXTğŸƒŒ-2)
    p.openâˆ˜â›wâ†’.write(txtÎ£á¦)

GRAM = â›
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
main = (ó°†´W âˆ¨ concat)*

atom = ó°†´w? â†· (macadd âˆ¨ macref âˆ¨ results âˆ¨ style âˆ¨ p_looper âˆ¨ p_concat âˆ¨ lookup)

macadd = ó°†´'Â¡' (ó°†´W? â†· (ó°†´',' â¯† word)) concat
macref = ó°†´'âŸ¨' ó°†´W? â†· (
      (macref_tag  =(ó°†´@ word))
    âˆ¨ (macref_notag=(   word))
) ó°†´'âŸ©'

results = (
    (ó°†´(W? 'ó°…') (ó°†´W âˆ¨ str âˆ¨ ~â€¹[^ó°…‚]â€º)* ó°†´'ó°…‚')
   âˆ¨(ó°†´âŸ¶        (ó°†´w âˆ¨ str âˆ¨ ~â€¹[^â âŸ§â†âŸ©\n\t ]â€º)*)
)

style = ó°†´'â¦‘' (ó°†´W? â†· (â ¶tuple âˆ¨ âœ“)) ó°†´'â¦’'
tuple = ((| (| âœ“)*)? chain)+
pair  = Æ¨(word) ó°†´W? â¦‘ â ¶tuple? â¦’
chain = (pair âˆ¨ word)+ ó°†´W?

concat = (â ¶atom)+
p_looper = ó°†´'âŸ¦' (ó°†´W âˆ¨ â ¶atom)* ó°†´'âŸ§'
p_concat = ó°†´'â…' (ó°†´W âˆ¨ â ¶atom)* ó°†´'â†'

lookup = str âˆ¨ Æ¨(chr âˆ¨ '|' âˆ¨ ',')
word   = Æ¨(str âˆ¨ chr+)
str    = Æ¨(â ¶esc âˆ¨ (ó°†´'"' ((esc âˆ¨ ~â€¹[^"]â€º)*) ó°†´'"'))
esc    = ó°†´â€¹â›â›â€º ~â€¹.?â€º

chr = Â¬bad ~â€¹.â€º
bad = ~â€¹["â âŸ¨âŸ©âŸ¦âŸ§â…â†â¦‘â¦’Â¡,|\t\n ]â€º

w = ~â€¹[ \t]+â€º
W = ~â€¹[ \t\nâ ]+â€º

(âŸ¦=ó°†´(W?â†·'âŸ¦'))(âŸ§=ó°†´(W?â†·'âŸ§'))(â…=ó°†´(W?â†·'â…'))(â†=ó°†´(W?â†·'â†'))
(â¦‘=ó°†´(W?â†·'â¦‘'))(â¦’=ó°†´(W?â†·'â¦’'))(âŸ¨=ó°†´(W?â†·'âŸ¨'))(âŸ©=ó°†´(W?â†·'âŸ©'))
(ó°…=ó°†´(W?â†·'ó°…'))(ó°…‚=ó°†´(W?â†·'ó°…‚'))(âŸ¶=ó°†´(W?â†·'âŸ¶'))(Â¡=ó°†´(W?â†·'Â¡'))
(|=ó°†´(W?â†·'|'))(@=ó°†´(W?â†·'@'))(,=ó°†´(W?â†·','))
ó°¦¥ó°¦¥ó°¦¥ó°¦¥ó°¦¥
î¬¦ ó°¤± newlines/seps in âŸ¦âŸ§ become concats?

head_types = â€¹R_S_Câ€‰R_S_0â€‰R_C_Sâ€‰R_Câ€‰R_S_1â€ºâ­
âŠ¢ process(DAT, MULTICHARS, SCRIPT_EXIST, SCRIPT_DEPTH, gram=Parser(GRAM)):
    dat = ğ—».joinâ†DAT.split(ğ—»)ó°ˆ³ó°²¡x.lstrip().startswithâ†â›î¬¦ó°…‚
    
    root = gram(datğŸŸ‘, DEBUG=âœ“, ONLY_NAMED=âœ“ğŸŸ‘) î¬¦ â† perf optmz herez
    root = root.child_killer(ó°²¡xáµ—âˆˆğ‘ â†â€¹â„œÂ¡|â›âŸ¦â›âŸ§â…â†â¦‘â¦’âŸ¨âŸ©âŸ¶â€º)
    root = root.find_replace(ó°²¡âœ“, ó°²¡(xáµ—âˆ§(xáµ—,xá¶œ)âˆ¨(xá¶œ,[])))
    root = (repâ‰”ó°²¡ğ(x)Â¿xá¹á”Â¡ğ(xâ‚€,â ¤xâ‚á´rep))âˆ˜root
    root = root.ftrp("strâ€‰word"â­, ó°²¡x.copy(xáµ—, c=[ğ(xá´ó°²¡xáµ—ó°…‚Î£á¦)]))
    root = root.ftrp(   "style"â­, ó°²¡x.copy(c=[ğ(decor(x))]))
    root = root.ftrp("p_looper"â­, ó°²¡x.copy("looper"), âœ“)
    root = root.ftrp("p_concat"â­, ó°²¡x.copy("concat"), âœ“)
    mac, lets = supermcdoublerecursivecomposeoutputstyleparsemachine(root)
    
    res = lets êŸ¿ ó°²£x î®† ó°²¡xá¹ğ‘¡âˆ§xâ‚€âˆˆ(â€¹TAGâ€‰STYLEâ€ºâ­)âˆ§xâ‚€ó°…‚ â›
                    â¥‰ ó°²¡(x.pop(âœ—), (x êŸ¿â±½ó°²£ yá´ ó°²¡xâ‚ó°…‚))ó°…‚ â›
                    â†’ +yâ›¶áµ€ó°…‚ â›
               î®† ó°²¡xâ‚‹â‚ó°…‚â›
               êŸ¿â±½ó°²£yá´ó°²¡xï¹•â‚‹â‚ó°…‚ó°…‚â›
               êŸ¿â±½ó°²£â„µ(    T = "reg",
                      out = x,
                     seqs = yêŸ¿ó°²£x,
                     tags = yêŸ¿ó°²£â„µó°ºó°»(y).TAG  ó°…‚Î£[] â¥‰ ğ‘ ,
                    style = yêŸ¿ó°²£â„µó°ºó°»(y).STYLEó°…‚Î£[] Å¿ó°¸ó°¹| â¥‰ â„µ)ó°…‚ â›
          â¥‰ â„µ
    
    get_psuedo_seqs = câ†¦[câ›¶] Â¿câˆˆsymmapÂ¡ resî Ë¢áµ‰î ‡Ë¢ Â¿câˆˆresÂ¡ â–¡
    make_script_seq_pre = â¥Œp,s,câ†¦[p]â‹…(2-â†câˆˆsymmap)+[â›ğ•ŠÂ¿câ‰¡pÂ¡s] î¬¦ áµƒ:\a ó°Œ:\\ağ•Š ô‹‘ª:\ğ•Š
    SCRIPT_EXIST = SCRIPT_EXIST.strip().split(ğ—») á´ á”.strip êŸ¿â° Î¶Â´ êŸ¿ó°²¥(x,yâ‹„z)ó°…‚ â¥‰ ğ‘‘
    already_script = ó°²£jâ‰”SCRIPT_EXIST.get(x,â´´) â†’âˆ§ â›â—Œâ‰ Hâ‰”j[yâ‰¡â›p] â†’âˆ§ H
    char = ó°²£(x, y, yâ‰ "mul"âˆ§already_script(x,yâ‚‹â‚) âˆ¨ get_codepoint(x,y)â‚€)
    
    force_include = ğ‘ (DAT + MULTICHARS)Î£á¦
    
    (symmap ó°ˆ³ó°²¡xâˆˆ"á´ğ•Š"âˆ¨xâˆˆres) á´ kâ†¦resâ‚–â‰”â„µ(
        T="NC",  out=k, seqs=get_psuedo_seqs(k), tags=ğ‘ (), style=â„µ)
    (force_include ó°ˆ³ó°²¡xâˆˆres) á´ kâ†¦resâ‚–â‰”â„µ(
        T="reg", out=k, seqs=[[â›â—Œ]]            , tags=ğ‘ (), style=â„µ)
    res.pop(ğ—», â–¡) î¬¦ lol
    â„­, â„œ = "â„­â„œ" á´ó°²¡mac.get(x, {})á´ó°²¡xâ‚ï¹•
    â„­á´ó°²¡xó°ˆ³ ó°²¡ xâ‚€â‰¡"TAG"ó°…‚ â›
        á´ ó°²¡ xÂ¿xá¹á”Â¡xâ‚ó°…‚ â›
        êŸ¿â°sâ†¦ğ”¸á´ó°²¡resâ‚“.style|=s
    
    multichars_dat = {}
    âˆ€mâˆˆMULTICHARS.stripî®¦â­:
        k = char(m, "mul")â‚‚
        resâ‚– = â„µ(T="mul", â­¡=ğ‘™(m), needs_gen=âœ“, ref=res.get(k, â„µ), out=k)
        multichars_datâ‚˜ = k
    
    seen = ğ‘ î®¦
    âˆ€_âˆˆSCRIPT_DEPTHâ­¥:
        âˆ€m âˆˆ ğ‘™(resâ»):
            Â¿mâˆˆseen: â†º
            âˆ€moder âˆˆ â€¹subâ€‰supâ€ºâ­:
                Â¿mğŸƒŒ>1: â†º î¬¦ ó°¤±
                k = char(m, moder)â‚‚
                resâ‚– = â„µ(T=moder, â­¡=[m], needs_gen=âœ“, ref=res.get(k, â„µ), out=k)
            seen.add(m)
    
    ğ† = []   
    ğ”” = resâ»ó°ˆ²ó°²¡resâ‚“.get("needs_gen")
    â° ğ””:
        ğ‘ = ğ””.popâˆ˜0
        ğ‘’ = res[ğ‘]
        
        Â¿(ğ‘’.â­¡ ó°ˆ² ó°²¡"needs_gen"âˆˆresâ‚“):
            ğ””.append(ğ‘)
            â†º
        â­¡ = ğ‘’.â­¡ á´ó°²¡resâ‚“
        
        ğ´ = (ğ‘’.out, â€¹âŸ¦ğ‘’áµ€âŸ§_âŸ¦ğ‘’.outâŸ§â€º)
        
        outs = â­¡á´ó°²¡x.out
        Â¿ğ‘’áµ€â‰¡"mul":
            ğ†.append( [add_multichar, (â ¤ğ´, outsÎ£á¦)] )
            style = ((h â‰” â­¡ ó°‘… ó°²¡"style"âˆˆx)âˆ§h.style) âˆ¨ {}
            ğ‘’.seqs = [outsá´ó°²¡[x, â›ğ•Š]ó°…‚Î£[â›á´]]
        Â¡:
            parent = â­¡â‚€
            Â¿already_script(parent.out, ğ‘’áµ€â‚‹â‚): î¬¦ we remove previous style
                ğ†.append( [remove_char, (ğ‘’.out, )] )
            ğ†.append( [add_script, (
                â ¤ğ´, râ‰”parent.out, ğ‘’áµ€â‚‹â‚,
                â­¡â‚€áµ€âˆˆâ€¹subâ€‰supâ€ºâ­ âˆ¨ "NO_SCALE"âˆ‰resáµ£.get("style", {}))] )
            style = parent.get("style", {})
            
            Â¿parent.outâˆˆâ€¹á¦á´ğ•Šâ€º:
                ğ‘’.seqs = [[â€¹/\â€º[ğ‘’áµ€â‚‹â‚â‰¡â›p]]+res[parent.out].seqsâ‚€] î¬¦ bruh
            Â¡:
                ğ‘’.seqs = [make_script_seq_pre(â€¹/\â€º[ğ‘’áµ€â‚‹â‚â‰¡â›p], parent.out, parent.out)]
        
        ref = ğ‘’.get("ref", â„µ)
        ğ‘’.seqs += ref.get("seqs", [])
        ğ‘’.tags  =      [â ¤â­¡, ğ‘’, ref] á´ó°²¡x.get("tags" ,set())ó°…‚ Å¿Ë¢áµ‰áµ—â½â¾ |
        ğ‘’.style = style |â† [ğ‘’, ref] á´ó°²¡x.get("style",   {})ó°…‚ Å¿ó°¸ó°¹    |
        ó°†´ ğ‘’["needs_gen"] , ğ‘’["ref"]
    
    res = normalize_seqs(res) î¬¦ ó°¤± - multichar output sub/sup
    
    ğ•© = resâº ó°ˆ²ó°²¡x.outğŸƒŒâ‰¡1 âˆ§ xáµ€âˆˆâ€¹subâ€‰supâ€ºâ­
    ğ•© = ğ•© î®† ó°²¡x.â­¡â‚€ó°…‚ â†’.itemsî®¦ êŸ¿ó°²£ yó°’½ó°²¡xáµ€ó°…‚á´ó°²¡x.outó°…‚ Î£ x
    script_mapâ‰”ğ•©â‰á´Î£Â´â†’á´ğŸƒŒâ¥‰ğ‘ â†’ğŸƒŒâ‰¡1â†’â¨³â€¹Unequal sup/sub/norm counts!â€º
    
    cmp_seqs = resâº ó°ˆ³ó°²¡x.outâ‰¡â›â—Œ âˆ¨ xáµ€â‰¡"NC"ó°…‚ á´câ†¦c.seqsá´ó°²¡(x, c.out)ó°…‚ó°…‚Î£[] ó°ˆ³ó°²¡xâ‚€âˆ‹â›â—Œó°…‚ â¥‰ ğ‘‘
    
    âŠ¢ convert_styles(styles):
        esc = ó°²£y Å¿Ë£ ó°²£x.replace(â ¤y)
        r = {}
        âˆ€s,Câˆˆstyles:
            C=â€¹([âŸ¦esc(C, â€¹\â€‰\\âŸ]â€‰\]âŸ-â€â€‰\-â€ºâ­)âŸ§]+)â€º
            ró°‚• = {"decorations": [ğ‘‘(s)]}
        â†ªr
    
    styles = collect_stylesâˆ˜res
    styles_dat = ğ‘‘âˆ˜styles
    
    styles = convert_stylesâˆ˜styles î¬¦ ó°¤± again multichar output stuff
    xcomp = xcompose_from_seqs(cmp_seqs)
    âˆ€Râˆˆâ„œ:
        (l,), s = R î®†á´® ó°²¡xá¹ğ‘¡âˆ§xâ‚€â‰¡"STYLE"
        l = lÂ¿lá¹á”Â¡lâ‚
        stylesâ‚—â‰”{"decorations": sá´ó°²¡xÂ¿xá¹á”Â¡xâ‚}
    save_puaî®¦
    
    â†ª â„µ(res=res, styles=styles, xcompose=xcomp, script_map=script_map,
        add_glyphs  = ğ’»â†¦ğ’»â—„â†ğ†êŸ¿ó°²£x(ğ’», â ¤y),
        set_codium  = ó°²¡edit_vs_settings(styles, x),
        set_compose = ó°²¡î¸¶(x, xcomp),
        write_multi = ó°²¡î¸¶(x, jdumps(multichars_dat)),
        write_style = ó°²¡î¸¶(x, jdumps(styles_dat)))